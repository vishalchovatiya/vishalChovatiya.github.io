<!doctype html><html lang=en dir=auto><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=&amp;path=livereload" data-no-instant defer></script><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>C++20 Coroutine: Under The Hood | Vishal Chovatiya</title>
<meta name=keywords content="awaitable,awaiter,c20-coroutine,c20-coroutine-terminology,co_await,co_return,co_yield,compiler-transformation-of-c-coroutine-related-keywords,coroutine-handle,coroutine-state,cpp-coroutine,generating-integer-sequence-using-c20-coroutine,how-does-c20-coroutine-gets-executed-2,promise,returning-a-value-from-c-coroutine,subroutine,suspending-a-c-coroutine,understanding-c20-coroutine-with-examples,what-is-c20-coroutine,what-is-coroutine-in-general,why-do-you-even-need-coroutine,yielding-a-value-from-c-coroutine"><meta name=description content="A coroutine is one of the major feature introduced with the C++20 standard apart from Module, Ranges & Concept. And you see how happy I am to unfold it. I already set the baseline on this topic with my previous article that Coroutine in C Language, where we saw, how suspension-resumption of execution works! With this article &ldquo;C++20 Coroutine: Under The Hood&rdquo;, we will see how compiler creates magic & standard library helps it with basic infrastructure making C++20 coroutine more sophisticated(yet complex) & scalable/customizable."><meta name=author content="Vishal Chovatiya"><link rel=canonical href=https://vishalchovatiya.github.io/posts/cpp20-coroutine-under-the-hood/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as=style><link rel=icon href=https://vishalchovatiya.github.io/images/trident_favicon.webp><link rel=icon type=image/png sizes=16x16 href=https://vishalchovatiya.github.io/images/trident_favicon.webp><link rel=icon type=image/png sizes=32x32 href=https://vishalchovatiya.github.io/images/trident_favicon.webp><link rel=apple-touch-icon href=https://vishalchovatiya.github.io/images/trident_favicon.webp><link rel=mask-icon href=https://vishalchovatiya.github.io/images/trident_favicon.webp><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://vishalchovatiya.github.io/posts/cpp20-coroutine-under-the-hood/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="C++20 Coroutine: Under The Hood"><meta property="og:description" content="A coroutine is one of the major feature introduced with the C++20 standard apart from Module, Ranges & Concept. And you see how happy I am to unfold it. I already set the baseline on this topic with my previous article that Coroutine in C Language, where we saw, how suspension-resumption of execution works! With this article &ldquo;C++20 Coroutine: Under The Hood&rdquo;, we will see how compiler creates magic & standard library helps it with basic infrastructure making C++20 coroutine more sophisticated(yet complex) & scalable/customizable."><meta property="og:type" content="article"><meta property="og:url" content="https://vishalchovatiya.github.io/posts/cpp20-coroutine-under-the-hood/"><meta property="og:image" content="https://vishalchovatiya.github.io/images/C20-Coroutine.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-05-09T00:00:00+00:00"><meta property="article:modified_time" content="2021-05-09T00:00:00+00:00"><meta property="og:site_name" content="Vishal Chovatiya"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://vishalchovatiya.github.io/images/C20-Coroutine.png"><meta name=twitter:title content="C++20 Coroutine: Under The Hood"><meta name=twitter:description content="A coroutine is one of the major feature introduced with the C++20 standard apart from Module, Ranges & Concept. And you see how happy I am to unfold it. I already set the baseline on this topic with my previous article that Coroutine in C Language, where we saw, how suspension-resumption of execution works! With this article &ldquo;C++20 Coroutine: Under The Hood&rdquo;, we will see how compiler creates magic & standard library helps it with basic infrastructure making C++20 coroutine more sophisticated(yet complex) & scalable/customizable."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://vishalchovatiya.github.io/posts/"},{"@type":"ListItem","position":2,"name":"C++20 Coroutine: Under The Hood","item":"https://vishalchovatiya.github.io/posts/cpp20-coroutine-under-the-hood/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"C++20 Coroutine: Under The Hood","name":"C\u002b\u002b20 Coroutine: Under The Hood","description":"A coroutine is one of the major feature introduced with the C++20 standard apart from Module, Ranges \u0026amp; Concept. And you see how happy I am to unfold it. I already set the baseline on this topic with my previous article that Coroutine in C Language, where we saw, how suspension-resumption of execution works! With this article \u0026ldquo;C++20 Coroutine: Under The Hood\u0026rdquo;, we will see how compiler creates magic \u0026amp; standard library helps it with basic infrastructure making C++20 coroutine more sophisticated(yet complex) \u0026amp; scalable/customizable.","keywords":["awaitable","awaiter","c20-coroutine","c20-coroutine-terminology","co_await","co_return","co_yield","compiler-transformation-of-c-coroutine-related-keywords","coroutine-handle","coroutine-state","cpp-coroutine","generating-integer-sequence-using-c20-coroutine","how-does-c20-coroutine-gets-executed-2","promise","returning-a-value-from-c-coroutine","subroutine","suspending-a-c-coroutine","understanding-c20-coroutine-with-examples","what-is-c20-coroutine","what-is-coroutine-in-general","why-do-you-even-need-coroutine","yielding-a-value-from-c-coroutine"],"articleBody":"A coroutine is one of the major feature introduced with the C++20 standard apart from Module, Ranges \u0026 Concept. And you see how happy I am to unfold it. I already set the baseline on this topic with my previous article that Coroutine in C Language, where we saw, how suspension-resumption of execution works! With this article “C++20 Coroutine: Under The Hood”, we will see how compiler creates magic \u0026 standard library helps it with basic infrastructure making C++20 coroutine more sophisticated(yet complex) \u0026 scalable/customizable.\nAt any point, you feel there is some jargons/terminology that is not known to you. Please keep reading forward. I have added a special section for it.\nWhat Is Coroutine In General? Please refer my previous article Coroutine in C Language for more. What Is C++20 Coroutine? A function that Contains keywords co_await, co_yield and/or co_return. Use a return type specifying a promise. From the higher abstraction, the C++20 coroutine consists of: Promise Defines overall coroutine behaviour. Act as a communicator between caller \u0026 called coroutine. Awaiter Controls suspension \u0026 resumption behaviour. Coroutine handle Controls execution behaviour. Why Do You Even Need Coroutine? I have already covered this in my earlier post Coroutine in C Language.\nHowever, if you still want to understand the need for coroutine with use case then please refer to Iterator Design Pattern With Modern C++.\nOr you can directly see the section of this article Generating Integer Sequence Using Coroutine.\nUnderstanding C++20 Coroutine With Examples Enough theory. Let’s talk code. Suspending a Coroutine Following is a lame \u0026 minimal example of a C++20 Coroutine. However, this is a very good starting point for beginner with slow pace \u0026 less cluttered code. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 #include #include struct HelloWorldCoro { struct promise_type { // compiler looks for `promise_type` HelloWorldCoro get_return_object() { return this; } std::suspend_always initial_suspend() { return {}; } std::suspend_always final_suspend() { return {}; } }; HelloWorldCoro(promise_type* p) : m_handle(std::coroutine_handle\u003cpromise_type\u003e::from_promise(*p)) {} ~HelloWorldCoro() { m_handle.destroy(); } std::coroutine_handle\u003cpromise_type\u003e m_handle; }; HelloWorldCoro print_hello_world() { std::cout \u003c\u003c \"Hello \"; co_await std::suspend_always{}; std::cout \u003c\u003c \"World!\" \u003c\u003c std::endl; } int main() { HelloWorldCoro mycoro = print_hello_world(); mycoro.m_handle.resume(); mycoro.m_handle(); // Equal to mycoro.m_handle.resume(); return EXIT_SUCCESS; } // g++-10 -std=c++20 -fcoroutines -fno-exceptions -o myapp Main.cpp A coroutine can be resumed by a resume member function of the std::coroutine_handle or by invoking the function call operator of the std::coroutine_handle object.\nAs I have mentioned earlier, the C++20 coroutine consists of:\nPromise i.e. promise_type\nType containing special methods like get_return_object(), initial_suspend(), final_suspend(), etc. that compiler use in coroutine transformation. Hence, it controls overall coroutine behaviour. Awaiter i.e. std::suspend_always\nEmpty class to suspend coroutine always. You can see the GCC implementation for this type here. Coroutine handle i.e. std::coroutine_handle\nHandler for coroutine that used to resume, destroy or check on a lifetime of coroutine. The compiler transforms the above print_hello_world coroutine as :\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 HelloWorldCoro print_hello_world() { __HelloWorldCoro_ctx* __context = new __HelloWorldCoro_ctx{}; auto __return = __context-\u003e_promise.get_return_object(); co_await __context-\u003e_promise.initial_suspend(); std::cout \u003c\u003c \"Hello \"; co_await std::suspend_always{ }; std::cout \u003c\u003c \"World!\" \u003c\u003c std::endl; __final_suspend_label: co_await __context-\u003e_promise.final_suspend(); delete __context; return __return; } As you can see, the compiler first creates the context(i.e. coroutine state) object. Which presumably look like: 1 2 3 4 5 6 7 8 struct __HelloWorldCoro_ctx { HelloWorldCoro::promise_type _promise; // storage for argument passed to coroutine // storage for local variables // storage for representation of the current suspension point }; // Standard doesn't define such type, rather compilers choose the type that suits its implementation. As seen, with the help of this context object, it creates the HelloWorldCoro object named as __return with the help of promise’s method get_return_object()\nFinally, one more level of transformation of co_await statements, coroutine would look like:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 HelloWorldCoro print_hello_world() { __HelloWorldCoro_ctx* __context = new __HelloWorldCoro_ctx{}; auto __return = __context-\u003e_promise.get_return_object(); { auto\u0026\u0026 awaiter = std::suspend_always{}; if (!awaiter.await_ready()) { awaiter.await_suspend(std::coroutine_handle\u003c\u003e p); // compiler added suspend/resume hook } awaiter.await_resume(); } std::cout \u003c\u003c \"Hello \"; { auto\u0026\u0026 awaiter = std::suspend_always{}; if (!awaiter.await_ready()) { awaiter.await_suspend(std::coroutine_handle\u003c\u003e p); // compiler added suspend/resume hook } awaiter.await_resume(); } std::cout \u003c\u003c \"World!\" \u003c\u003c std::endl; __final_suspend_label: { auto\u0026\u0026 awaiter = std::suspend_always{}; if (!awaiter.await_ready()) { awaiter.await_suspend(std::coroutine_handle\u003c\u003e p); // compiler added suspend/resume hook } awaiter.await_resume(); } return __return; } As you can see our HelloWorldCoro::promise_type::initial_suspend()\n\u0026 HelloWorldCoro::promise_type::final_suspend()returns std::suspend_always. Whose, method std::suspend_always::await_ready()in turn returns false always. So our coroutine will be suspended every time it encounters co_await.\nReturning a Value From Coroutine 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 #include #include #include struct HelloWorldCoro { struct promise_type { int m_value; HelloWorldCoro get_return_object() { return this; } std::suspend_always initial_suspend() { return {}; } std::suspend_always final_suspend() { return {}; } void return_value(int val) { m_value = val; } }; HelloWorldCoro(promise_type* p) : m_handle(std::coroutine_handle\u003cpromise_type\u003e::from_promise(*p)) {} ~HelloWorldCoro() { m_handle.destroy(); } std::coroutine_handle\u003cpromise_type\u003e m_handle; }; HelloWorldCoro print_hello_world() { std::cout \u003c\u003c \"Hello \"; co_await std::suspend_always{ }; std::cout \u003c\u003c \"World!\" \u003c\u003c std::endl; co_return -1; } int main() { HelloWorldCoro mycoro = print_hello_world(); mycoro.m_handle.resume(); mycoro.m_handle.resume(); assert(mycoro.m_handle.promise().m_value == -1); return EXIT_SUCCESS; } To return a value from a coroutine, you need to supply return_value()method to promise type. In other words, the compiler expects the method named return_value with appropriate argument.\nAnd, if you don’t supply it to promise type, you will be prompted with the below error:\n1 2 3 Main.cpp:27:5: error: no member named ‘return_value’ in ‘std::__n4861::__coroutine_traits_impl\u003cHelloWorldCoro, void\u003e::promise_type’ {aka ‘HelloWorldCoro::promise_type’} 27 | co_return -1; | ^~~~~~~~~ This return_value()method is then used by compiler to transform the co_return statement as below: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 HelloWorldCoro print_hello_world() { __HelloWorldCoro_ctx* __context = new __HelloWorldCoro_ctx{}; auto __return = __context-\u003e_promise.get_return_object(); co_await __context-\u003e_promise.initial_suspend(); std::cout \u003c\u003c \"Hello \"; co_await std::suspend_always{ }; std::cout \u003c\u003c \"World!\" \u003c\u003c std::endl; __context-\u003e_promise.return_value(-1); goto __final_suspend_label; __final_suspend_label: co_await __context-\u003e_promise.final_suspend(); delete __context; return __return; } As you might have noticed, co_return transformation is plain vanilla, where the compiler just passes the return value to the promise object \u0026 jump to the final suspend label.\nI will not expand the co_await statements again. Otherwise, the code will become messy. However, by now, you can guess what could be there.\nYielding a Value From Coroutine 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 #include #include #include struct HelloWorldCoro { struct promise_type { int m_val; HelloWorldCoro get_return_object() { return this; } std::suspend_always initial_suspend() { return {}; } std::suspend_always final_suspend() { return {}; } std::suspend_always yield_value(int val) { m_val = val; return {}; } }; HelloWorldCoro(promise_type* p) : m_handle(std::coroutine_handle\u003cpromise_type\u003e::from_promise(*p)) {} ~HelloWorldCoro() { m_handle.destroy(); } std::coroutine_handle\u003cpromise_type\u003e m_handle; }; HelloWorldCoro print_hello_world() { std::cout \u003c\u003c \"Hello \"; co_yield 1; std::cout \u003c\u003c \"World!\" \u003c\u003c std::endl; } int main() { HelloWorldCoro mycoro = print_hello_world(); mycoro.m_handle.resume(); assert(mycoro.m_handle.promise().m_val == 1); mycoro.m_handle.resume(); return EXIT_SUCCESS; } As we have done in returning a value from a coroutine, to yield anything from coroutine you need to supply the yield_value()method to promise_type that returns awaitable type.\nOnce again, the compiler transforms the coroutine that yields as:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 HelloWorldCoro print_hello_world() { __HelloWorldCoro_ctx* __context = new __HelloWorldCoro_ctx{}; auto __return = __context-\u003e_promise.get_return_object(); co_await __context-\u003e_promise.initial_suspend(); std::cout \u003c\u003c \"Hello \"; co_await __context-\u003e_promise.yield_value(1); std::cout \u003c\u003c \"World!\" \u003c\u003c std::endl; __final_suspend_label: co_await __context-\u003e_promise.final_suspend(); delete __context; return __return; } As you can see co_yield statement transformed into co_await considering the promise’s method(i.e. yield_value() call as expression. That returns std::suspend_always so our coroutine will be suspended thereafter yielding a value. Generating Integer Sequence Using C++20 Coroutine So, that we understood the compiler transformations of coroutine, let’s do something meaningful with coroutine. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 #include #include #include struct Generator { struct promise_type { int m_val; Generator get_return_object() { return this; } std::suspend_never initial_suspend() { return {}; } std::suspend_always final_suspend() { return {}; } std::suspend_always yield_value(int val) { m_val = val; return {}; } }; /* ---------------------------- Iterator Implementation ----------------------------- */ struct iterator { bool operator!=(const iterator\u0026 rhs) { return not m_h_ptr-\u003edone(); } iterator\u0026 operator++() { m_h_ptr-\u003eresume(); return *this; } int operator*() { return m_h_ptr-\u003epromise().m_val; } std::coroutine_handle\u003cpromise_type\u003e *m_h_ptr; }; iterator begin() { return iterator{\u0026m_handle}; } iterator end() { return iterator{nullptr}; } /* ---------------------------------------------------------------------------------- */ Generator(promise_type* p) : m_handle(std::coroutine_handle\u003cpromise_type\u003e::from_promise(*p)) {} ~Generator() { m_handle.destroy(); } std::coroutine_handle\u003cpromise_type\u003e m_handle; }; Generator range(uint32_t start, uint32_t end) { while(start != end) co_yield start++; } int main() { for (auto \u0026\u0026no : range(0, 10)) { // Isn't this look like Python ! std::cout\u003c\u003c no \u003c\u003cstd::endl; } return EXIT_SUCCESS; } A range()function of the above code will generate the integers on every iteration on a need basis. Instead of generating \u0026 returning precomputed sequence.\nFor the rest of the code, I suggest you spend some time with patience. And play around it.\nAnd, If you are thinking that why do we need iterator implementation inside Generator, then please learn How Range Based `for` Loop Works In C++!.\nC++20 Coroutine Terminology This section should have been at beginning of the article. However, I believe that until you understand how coroutine works under the hood, you won’t be able to connect the dots on C++20 coroutine jargons( or won’t understand data type naming convention).\nBy this time you are able to write a C++ coroutine \u0026 you can ignore this section. Nonetheless, it is just that you will have a hard time communicating with fellow C++ developers \u0026 reading cppreference. If you do so.\nAwaitable A type that supports the co_await operator is called an Awaitable type.\nC++20 introduced a new unary operator co_await that can be applied to an expression. For example:\n1 2 3 4 5 6 7 8 9 struct dummy { // Awaitable std::suspend_always operator co_await(){ return {}; } }; HelloWorldCoro print_hello_world() { std::cout \u003c\u003c \"Hello \"; co_await dummy{}; std::cout \u003c\u003c \"World!\" \u003c\u003c std::endl; } Awaiter 1 2 3 4 5 6 7 8 9 10 11 struct my_awaiter { bool await_ready() { return false; } void await_suspend(std::coroutine_handle\u003c\u003e) {} void await_resume() {} }; HelloWorldCoro print_hello_world() { std::cout \u003c\u003c \"Hello \"; co_await my_awaiter{}; std::cout \u003c\u003c \"World!\" \u003c\u003c std::endl; } An Awaiter type is a type that implements the three special methods that are called as part of a co_await expression: await_ready(), await_suspend() and await_resume() For example, standard library defined trivial awaiters i.e. std::suspend_always \u0026 std::suspend_never.\nNote that a type can be both an Awaitable type and an Awaiter type.\nco_await co_await is a unary operator that suspends a coroutine and returns control to the caller. Its operand is an expression whose type must either define operator co_await, or Awaitable. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 struct dummy { }; // Awaitable struct HelloWorldCoro { struct promise_type { // . . . auto await_transform(const dummy\u0026) { return std::suspend_always{}; } }; // . . . }; HelloWorldCoro print_hello_world() { std::cout \u003c\u003c \"Hello \"; co_await dummy{}; std::cout \u003c\u003c \"World!\" \u003c\u003c std::endl; } Promise A type strictly named as promise_type.\nThe promise object is used inside the coroutine. The coroutine submits its result or exception through this object.\nThe promise type is determined by the compiler from the return type of the coroutine using std::coroutine_traits.\nCoroutine Handle The coroutine handle used to resume the execution of the coroutine or to destroy the coroutine frame. It does also indicates the status of coroutine using std::coroutine_handle::done()method. Coroutine State The coroutine state(referred to as a context object) is a compiler-generated, heap-allocated (unless the allocation is optimized out) object that contains Promise object. Parameters (all copied by value). Local variables. Representation of the current suspension point, so that resume knows where to continue and destroy knows what local variables were in scope. How Does Coroutine Gets Executed! Ahh…! it’s time for the real magic!\nNow, that we saw how the compiler does the magic with coroutine keywords co_await, co_yield \u0026 co_return. Let’s understand how it gets executed.\nBut, Before, we move forward, let me clarify some points:\nC++ Standard doesn’t bother about implementation rather it only states behaviour. Hence implementation of the coroutine is completely dependent on the compiler \u0026 library writers. To see that, you can check the library implementation of std::coroutine_handle::resume()that uses __builtin_coro_resume which is provided by the GCC compiler. Proving that the library \u0026 compiler is tightly coupled.\nWith that being said, I have not written any C++ library or compiler in my career. Though I have written/ported the core C library for proprietary architecture. So, whatever you see in this section is just to build your intuition on how coroutine can be implemented. Based on my research \u0026 intuition.\nThere are two ways I can see this can be done:\nHypothesis 1 For example, If you have defined your coroutine as: 1 2 3 4 5 6 7 8 HelloWorldCoro print_hello_world(int a) { int b = 10; co_await std::suspend_always{}; a = 10; int c = 10; co_await std::suspend_always{}; co_return a + b + c; } Then, operations can be divided into 3 different sections separated by 2 suspension-point(i.e. co_await ) as\nint b = 10;\na = 10; int c = 10;\nco_return a + b + c;\nConsidering these suspension points, then the compiler basically\nRewrite your coroutine into a bit like functions.\nAnd create a copy of all local variables as a data member of the coroutine state object.\nYou can assume coroutine state object layout as:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 struct print_hello_world { print_hello_world(int a_) : a{a}{} // Coroutine state object with coroutine arguments void _s1(){ // Before suspension point 1 operations int b = 10; sp = 1; // switching call back based on suspension point } void _s2(){ // Operations b/w suspension point 1 \u0026 2 a = 10; int c = 10; sp = 2; } void _s3(){ // Operations after suspension point 2 promise.return_value(a + b + c); // After execution, coro_done = true; coro_done = true; } int a, b, c; // Local variables promise_type\u0026 promise; void (*s_cb)[] = {_s1, _s2, _s3}; // suspension point callbacks int sp{0}; // current suspension point(sp) bool coro_done{false}; }; Now, when you call coroutine, you are basically creating a coroutine state object with a similar argument to that of coroutine. 1 2 3 4 5 auto mycoro = print_hello_world(5); // transform into print_hello_world mycoro(5); As you might have guessed, due to rewriting coroutine into tiny functions, we don’t need a suspension mechanism anymore. And resumption can be implemented as: 1 2 3 4 void std::coroutine_handle::resume() { if(not print_hello_world::coro_done) print_hello_world::s_cb[sp](); } So, when you call resume you are basically calling the suspension-point specific tiny function(technically its method) from a coroutine state object. That implies the creation of two stack frame i.e. std::coroutine_handle::resume()\u0026 print_hello_world::_sX(), where X stands for a suspension point number. Consequently not needing a separate stack \u0026 using the same stack as the caller. And this is why C++20 coroutines are stackless coroutine \u0026 faster.\nI agree that the above example is not compilable, don’t cover edge cases \u0026 doesn’t consider customized(i.e. awaiter object) coroutine behaviour. But, with the intuition we just built, you can easily create a mental model of coroutine \u0026 see the compiler perspective.\nAnd to test your intuition capability, just imagine How you can transform the tiny functions for the coroutine that contains co_await expression in a for loop?\nHypothesis 2 Another usual way you can implement suspension-resumption is with the help of context switching APIs. For example, in the expansion of co_wait statement, I have mentioned the comment “compiler added suspend/resume hook” as below. 1 2 3 4 5 6 7 8 { auto\u0026\u0026 awaiter = std::suspend_always{}; if (!awaiter.await_ready()) { awaiter.await_suspend(std::coroutine_handle\u003c\u003e p); // compiler added suspend/resume hook } awaiter.await_resume(); } This is the place where your compiler adds its secret sauce to your code with context switching APIs. And rest is I think easy to imagine if you have read my earlier post Coroutine in C Language thoroughly. Summary Subroutine vs Coroutine Subroutines Coroutines call calling convention i.e. foo() calling convention i.e. foo() suspend Can’t suspend co_await/co_yield expression resume Can’t suspend coroutine_handle\u003c\u003e::resume() return return statement co_return statement Compiler Transformation Of Coroutine Related Keywords 1 2 3 4 5 6 co_return x; // transforms into __promise.return_value(x); goto __final_suspend_label; 1 2 3 4 5 6 7 8 9 10 co_await y; // transforms into auto\u0026\u0026 __awaitable = y; if (__awaitable.await_ready()) { __awaitable.await_suspend(); // compiler added suspend/resume hook } __awaitable.await_resume(); 1 2 3 4 5 co_yield z; // transforms into co_await __promise.yield_value(z); Parting Words With FAQs This is not just it, there are still many things that we haven’t explored like exception handling, coroutine calling coroutine, etc.\nOne unusual thing I observed about C++20 Coroutine is, You have to specify the return type even if you don’t return anything from the coroutine. IMO, this is unusual \u0026 counter-intuitive.\nWhat does it mean by stackfull \u0026 stackless coroutine?\nstackfull coroutines need a separate stack to be executed. stackless coroutine uses the same stack as of caller. Difference between threads \u0026 coroutines?\nCoroutines are about your programming model and threads are about your execution model. co-routine can still do concurrency without scheduler overhead - it simply manages the context-switching itself. Another benefit is the much lower memory usage. With the threaded model, each thread needs to allocate its own stack, and so your memory usage grows linearly with the number of threads you have. What does it mean by “coroutines are like lightweight threads”?\nFirst of all, coroutines \u0026 threads are a different entity. Because coroutine can be stackless \u0026 doesn’t need OS intervention on schedule, it is lower on memory footprint \u0026 faster on execution as compared to thread. With C++, it’s, even more, faster if you use Hypothesis 1. How come C++ coroutine are stackless?\nThis is already answered in Hypothesis 1. Still one more time. The compiler “returns” a handle to this dynamically allocated coroutine frame to the caller of the coroutine. When a caller calls std::coroutine_handle::resume() method, stackframe for std::coroutine_handle::resume() will be created which resumes the coroutine while processing all coroutine data on a dynamically allocated coroutine frame. And this is how coroutine is stackless in C++. Because it executes in the current stack only. Instead of a separate coroutine stack. ","wordCount":"3199","inLanguage":"en","image":"https://vishalchovatiya.github.io/images/C20-Coroutine.png","datePublished":"2021-05-09T00:00:00Z","dateModified":"2021-05-09T00:00:00Z","author":{"@type":"Person","name":"Vishal Chovatiya"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://vishalchovatiya.github.io/posts/cpp20-coroutine-under-the-hood/"},"publisher":{"@type":"Organization","name":"Vishal Chovatiya","logo":{"@type":"ImageObject","url":"https://vishalchovatiya.github.io/images/trident_favicon.webp"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://vishalchovatiya.github.io/ accesskey=h title="Vishal Chovatiya (Alt + H)"><img src=https://vishalchovatiya.github.io/apple-touch-icon.png alt aria-label=logo height=35>Vishal Chovatiya</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://vishalchovatiya.github.io/pages/vishal-chovatiya title="About Me"><span>About Me</span></a></li><li><a href=https://vishalchovatiya.github.io/pages/start-here title="Start Here"><span>Start Here</span></a></li><li><a href=https://vishalchovatiya.github.io/posts/ title=Latest><span>Latest</span></a></li><li><a href=https://vishalchovatiya.github.io/categories/ title=Categories><span>Categories</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://vishalchovatiya.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://vishalchovatiya.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">C++20 Coroutine: Under The Hood</h1><div class=post-meta><span title='2021-05-09 00:00:00 +0000 UTC'>May 9, 2021</span>&nbsp;·&nbsp;16 min&nbsp;·&nbsp;3199 words&nbsp;·&nbsp;Vishal Chovatiya&nbsp;|&nbsp;<a href=https://github.com/vishalchovatiya/blog/blob/main/vishalchovatiya/content/posts/cpp20-coroutine-under-the-hood.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><figure class=entry-cover><img loading=eager src=https://vishalchovatiya.github.io/images/C20-Coroutine.png alt></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#what-is-coroutine-in-general>What Is Coroutine In General?</a></li><li><a href=#what-is-c20-coroutine>What Is C++20 Coroutine?</a></li><li><a href=#why-do-you-even-need-coroutine>Why Do You Even Need Coroutine?</a></li><li><a href=#understanding-c20coroutine-with-examples>Understanding C++20 Coroutine With Examples</a><ul><li><a href=#suspending-a-coroutine>Suspending a Coroutine</a></li><li><a href=#returning-a-value-from-coroutine>Returning a Value From Coroutine</a></li><li><a href=#yielding-a-value-from-coroutine>Yielding a Value From Coroutine</a></li></ul></li><li><a href=#generating-integer-sequence-using-c20-coroutine>Generating Integer Sequence Using C++20 Coroutine</a></li><li><a href=#c20coroutine-terminology>C++20 Coroutine Terminology</a><ul><li><a href=#awaitable>Awaitable</a></li><li><a href=#awaiter>Awaiter</a></li><li><a href=#co_await><code>co_await</code></a></li><li><a href=#promise>Promise</a></li><li><a href=#coroutine-handle>Coroutine Handle</a></li><li><a href=#coroutine-state>Coroutine State</a></li></ul></li><li><a href=#how-does-coroutine-gets-executed>How Does Coroutine Gets Executed!</a><ul><li><a href=#hypothesis-1>Hypothesis 1</a></li><li><a href=#hypothesis-2>Hypothesis 2</a></li></ul></li><li><a href=#summary>Summary</a><ul><li><a href=#subroutine-vs-coroutine>Subroutine vs Coroutine</a></li><li><a href=#compiler-transformation-of-coroutine-related-keywords>Compiler Transformation Of Coroutine Related Keywords</a></li></ul></li><li><a href=#parting-words-with-faqs>Parting Words With FAQs</a></li></ul></nav></div></details></div><div class=post-content><p>A coroutine is one of the major feature introduced with the C++20 standard apart from <a href=https://en.cppreference.com/w/cpp/language/modules>Module</a>, <a href=https://en.cppreference.com/w/cpp/ranges>Ranges</a> & <a href=https://en.cppreference.com/w/cpp/concepts>Concept</a>. And you see how happy I am to unfold it. I already set the baseline on this topic with my previous article that <a href=/posts/coroutine-in-c-language/>Coroutine in C Language</a>, where we saw, how suspension-resumption of execution works! With this article &ldquo;C++20 Coroutine: Under The Hood&rdquo;, we will see how compiler creates magic & standard library helps it with basic infrastructure making C++20 coroutine more sophisticated(yet complex) & scalable/customizable.</p><p>At any point, you feel there is some jargons/terminology that is not known to you. Please keep reading forward. I have added a <a href=/posts/cpp20-coroutine-under-the-hood/#C20nbspCoroutine_Terminology>special section</a> for it.</p><h2 id=what-is-coroutine-in-general>What Is Coroutine In General?<a hidden class=anchor aria-hidden=true href=#what-is-coroutine-in-general>#</a></h2><p><img loading=lazy src=/images/C20-Coroutine-Under-The-Hood.png#center alt=Cpp20-Coroutine-Under-The-Hood></p><ul><li>Please refer my previous article <a href=/posts/coroutine-in-c-language>Coroutine in C Language</a> for more.</li></ul><h2 id=what-is-c20-coroutine>What Is C++20 Coroutine?<a hidden class=anchor aria-hidden=true href=#what-is-c20-coroutine>#</a></h2><ul><li>A function that<ol><li>Contains keywords <code>co_await</code>, <code>co_yield</code> and/or <code>co_return</code>.</li><li>Use a return type specifying a promise.</li></ol></li><li>From the higher abstraction, the C++20 coroutine consists of:<ol><li>Promise<ul><li>Defines overall coroutine behaviour.</li><li>Act as a communicator between caller & called coroutine.</li></ul></li><li>Awaiter<ul><li>Controls suspension & resumption behaviour.</li></ul></li><li>Coroutine handle<ul><li>Controls execution behaviour.</li></ul></li></ol></li></ul><h2 id=why-do-you-even-need-coroutine>Why Do You Even Need Coroutine?<a hidden class=anchor aria-hidden=true href=#why-do-you-even-need-coroutine>#</a></h2><ul><li><p>I have already covered this in my earlier post <a href=/posts/coroutine-in-c-language/>Coroutine in C Language</a>.</p></li><li><p>However, if you still want to understand the need for coroutine with use case then please refer to <a href=/posts/iterator-design-pattern-in-modern-cpp/>Iterator Design Pattern With Modern C++</a>.</p></li><li><p>Or you can directly see the section of this article <a href=/posts/cpp20-coroutine-under-the-hood/#Generating_Integer_Sequence_Using_C20_Coroutine>Generating Integer Sequence Using Coroutine</a>.</p></li></ul><h2 id=understanding-c20coroutine-with-examples>Understanding C++20 Coroutine With Examples<a hidden class=anchor aria-hidden=true href=#understanding-c20coroutine-with-examples>#</a></h2><ul><li>Enough theory. Let&rsquo;s talk code.</li></ul><h3 id=suspending-a-coroutine>Suspending a Coroutine<a hidden class=anchor aria-hidden=true href=#suspending-a-coroutine>#</a></h3><ul><li>Following is a lame & minimal example of a C++20 Coroutine. However, this is a very good starting point for beginner with slow pace & less cluttered code.</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-0-1><a class=lnlinks href=#hl-0-1> 1</a>
</span><span class=lnt id=hl-0-2><a class=lnlinks href=#hl-0-2> 2</a>
</span><span class=lnt id=hl-0-3><a class=lnlinks href=#hl-0-3> 3</a>
</span><span class=lnt id=hl-0-4><a class=lnlinks href=#hl-0-4> 4</a>
</span><span class=lnt id=hl-0-5><a class=lnlinks href=#hl-0-5> 5</a>
</span><span class=lnt id=hl-0-6><a class=lnlinks href=#hl-0-6> 6</a>
</span><span class=lnt id=hl-0-7><a class=lnlinks href=#hl-0-7> 7</a>
</span><span class=lnt id=hl-0-8><a class=lnlinks href=#hl-0-8> 8</a>
</span><span class=lnt id=hl-0-9><a class=lnlinks href=#hl-0-9> 9</a>
</span><span class=lnt id=hl-0-10><a class=lnlinks href=#hl-0-10>10</a>
</span><span class=lnt id=hl-0-11><a class=lnlinks href=#hl-0-11>11</a>
</span><span class=lnt id=hl-0-12><a class=lnlinks href=#hl-0-12>12</a>
</span><span class=lnt id=hl-0-13><a class=lnlinks href=#hl-0-13>13</a>
</span><span class=lnt id=hl-0-14><a class=lnlinks href=#hl-0-14>14</a>
</span><span class=lnt id=hl-0-15><a class=lnlinks href=#hl-0-15>15</a>
</span><span class=lnt id=hl-0-16><a class=lnlinks href=#hl-0-16>16</a>
</span><span class=lnt id=hl-0-17><a class=lnlinks href=#hl-0-17>17</a>
</span><span class=lnt id=hl-0-18><a class=lnlinks href=#hl-0-18>18</a>
</span><span class=lnt id=hl-0-19><a class=lnlinks href=#hl-0-19>19</a>
</span><span class=lnt id=hl-0-20><a class=lnlinks href=#hl-0-20>20</a>
</span><span class=lnt id=hl-0-21><a class=lnlinks href=#hl-0-21>21</a>
</span><span class=lnt id=hl-0-22><a class=lnlinks href=#hl-0-22>22</a>
</span><span class=lnt id=hl-0-23><a class=lnlinks href=#hl-0-23>23</a>
</span><span class=lnt id=hl-0-24><a class=lnlinks href=#hl-0-24>24</a>
</span><span class=lnt id=hl-0-25><a class=lnlinks href=#hl-0-25>25</a>
</span><span class=lnt id=hl-0-26><a class=lnlinks href=#hl-0-26>26</a>
</span><span class=lnt id=hl-0-27><a class=lnlinks href=#hl-0-27>27</a>
</span><span class=lnt id=hl-0-28><a class=lnlinks href=#hl-0-28>28</a>
</span><span class=lnt id=hl-0-29><a class=lnlinks href=#hl-0-29>29</a>
</span><span class=lnt id=hl-0-30><a class=lnlinks href=#hl-0-30>30</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;coroutine&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;iostream&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=nc>HelloWorldCoro</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=nc>promise_type</span> <span class=p>{</span> <span class=c1>// compiler looks for `promise_type`
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>HelloWorldCoro</span> <span class=nf>get_return_object</span><span class=p>()</span> <span class=p>{</span> <span class=k>return</span> <span class=k>this</span><span class=p>;</span> <span class=p>}</span>    
</span></span><span class=line><span class=cl>        <span class=n>std</span><span class=o>::</span><span class=n>suspend_always</span> <span class=n>initial_suspend</span><span class=p>()</span> <span class=p>{</span> <span class=k>return</span> <span class=p>{};</span> <span class=p>}</span>        
</span></span><span class=line><span class=cl>        <span class=n>std</span><span class=o>::</span><span class=n>suspend_always</span> <span class=n>final_suspend</span><span class=p>()</span> <span class=p>{</span> <span class=k>return</span> <span class=p>{};</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>HelloWorldCoro</span><span class=p>(</span><span class=n>promise_type</span><span class=o>*</span> <span class=n>p</span><span class=p>)</span> <span class=o>:</span> <span class=n>m_handle</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>coroutine_handle</span><span class=o>&lt;</span><span class=n>promise_type</span><span class=o>&gt;::</span><span class=n>from_promise</span><span class=p>(</span><span class=o>*</span><span class=n>p</span><span class=p>))</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=o>~</span><span class=n>HelloWorldCoro</span><span class=p>()</span> <span class=p>{</span> <span class=n>m_handle</span><span class=p>.</span><span class=n>destroy</span><span class=p>();</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>coroutine_handle</span><span class=o>&lt;</span><span class=n>promise_type</span><span class=o>&gt;</span>      <span class=n>m_handle</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>HelloWorldCoro</span> <span class=nf>print_hello_world</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;Hello &#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>co_await</span> <span class=n>std</span><span class=o>::</span><span class=n>suspend_always</span><span class=p>{};</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;World!&#34;</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>HelloWorldCoro</span> <span class=n>mycoro</span> <span class=o>=</span> <span class=n>print_hello_world</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>mycoro</span><span class=p>.</span><span class=n>m_handle</span><span class=p>.</span><span class=n>resume</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>mycoro</span><span class=p>.</span><span class=n>m_handle</span><span class=p>();</span> <span class=c1>// Equal to mycoro.m_handle.resume();
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=n>EXIT_SUCCESS</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// g++-10 -std=c++20 -fcoroutines -fno-exceptions -o myapp Main.cpp
</span></span></span></code></pre></td></tr></table></div></div><ul><li><p>A coroutine can be resumed by a resume member function of the <code>std::coroutine_handle</code> or by invoking the function call operator of the <code>std::coroutine_handle</code> object.</p></li><li><p>As I have mentioned earlier, the C++20 coroutine consists of:</p><ol><li><p>Promise i.e. <a href=https://en.cppreference.com/w/cpp/coroutine/coroutine_traits>promise_type</a></p><ul><li>Type containing special methods like get_return_object(), initial_suspend(), final_suspend(), etc. that compiler use in coroutine transformation. Hence, it controls overall coroutine behaviour.</li></ul></li><li><p>Awaiter i.e. <a href=https://en.cppreference.com/w/cpp/coroutine/suspend_always>std::suspend_always</a></p><ol><li>Empty class to suspend coroutine always.</li></ol><ul><li>You can see the GCC implementation for this type <a href=https://github.com/gcc-mirror/gcc/blob/master/libstdc%2B%2B-v3/include/std/coroutine#L313>here</a>.</li></ul></li><li><p>Coroutine handle i.e. <a href=https://en.cppreference.com/w/cpp/coroutine/coroutine_handle>std::coroutine_handle</a></p><ul><li>Handler for coroutine that used to resume, destroy or check on a lifetime of coroutine.</li></ul></li></ol></li><li><p>The compiler transforms the above <code>print_hello_world</code> coroutine as :</p></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-1-1><a class=lnlinks href=#hl-1-1> 1</a>
</span><span class=lnt id=hl-1-2><a class=lnlinks href=#hl-1-2> 2</a>
</span><span class=lnt id=hl-1-3><a class=lnlinks href=#hl-1-3> 3</a>
</span><span class=lnt id=hl-1-4><a class=lnlinks href=#hl-1-4> 4</a>
</span><span class=lnt id=hl-1-5><a class=lnlinks href=#hl-1-5> 5</a>
</span><span class=lnt id=hl-1-6><a class=lnlinks href=#hl-1-6> 6</a>
</span><span class=lnt id=hl-1-7><a class=lnlinks href=#hl-1-7> 7</a>
</span><span class=lnt id=hl-1-8><a class=lnlinks href=#hl-1-8> 8</a>
</span><span class=lnt id=hl-1-9><a class=lnlinks href=#hl-1-9> 9</a>
</span><span class=lnt id=hl-1-10><a class=lnlinks href=#hl-1-10>10</a>
</span><span class=lnt id=hl-1-11><a class=lnlinks href=#hl-1-11>11</a>
</span><span class=lnt id=hl-1-12><a class=lnlinks href=#hl-1-12>12</a>
</span><span class=lnt id=hl-1-13><a class=lnlinks href=#hl-1-13>13</a>
</span><span class=lnt id=hl-1-14><a class=lnlinks href=#hl-1-14>14</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=n>HelloWorldCoro</span> <span class=nf>print_hello_world</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>__HelloWorldCoro_ctx</span><span class=o>*</span> <span class=n>__context</span> <span class=o>=</span> <span class=k>new</span> <span class=n>__HelloWorldCoro_ctx</span><span class=p>{};</span>
</span></span><span class=line><span class=cl>    <span class=k>auto</span> <span class=n>__return</span> <span class=o>=</span> <span class=n>__context</span><span class=o>-&gt;</span><span class=n>_promise</span><span class=p>.</span><span class=n>get_return_object</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>co_await</span> <span class=n>__context</span><span class=o>-&gt;</span><span class=n>_promise</span><span class=p>.</span><span class=n>initial_suspend</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;Hello &#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>co_await</span> <span class=n>std</span><span class=o>::</span><span class=n>suspend_always</span><span class=p>{</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;World!&#34;</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nl>__final_suspend_label</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>co_await</span> <span class=n>__context</span><span class=o>-&gt;</span><span class=n>_promise</span><span class=p>.</span><span class=n>final_suspend</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>delete</span> <span class=n>__context</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>__return</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>As you can see, the compiler first creates the context(i.e. coroutine state) object. Which presumably look like:</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-2-1><a class=lnlinks href=#hl-2-1>1</a>
</span><span class=lnt id=hl-2-2><a class=lnlinks href=#hl-2-2>2</a>
</span><span class=lnt id=hl-2-3><a class=lnlinks href=#hl-2-3>3</a>
</span><span class=lnt id=hl-2-4><a class=lnlinks href=#hl-2-4>4</a>
</span><span class=lnt id=hl-2-5><a class=lnlinks href=#hl-2-5>5</a>
</span><span class=lnt id=hl-2-6><a class=lnlinks href=#hl-2-6>6</a>
</span><span class=lnt id=hl-2-7><a class=lnlinks href=#hl-2-7>7</a>
</span><span class=lnt id=hl-2-8><a class=lnlinks href=#hl-2-8>8</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>struct</span> <span class=nc>__HelloWorldCoro_ctx</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>HelloWorldCoro</span><span class=o>::</span><span class=n>promise_type</span> <span class=n>_promise</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// storage for argument passed to coroutine
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// storage for local variables
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// storage for representation of the current suspension point
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Standard doesn&#39;t define such type, rather compilers choose the type that suits its implementation.
</span></span></span></code></pre></td></tr></table></div></div><ul><li><p>As seen, with the help of this context object, it creates the <code>HelloWorldCoro</code> object named as <code>__return</code> with the help of promise&rsquo;s method <code>get_return_object()</code></p></li><li><p>Finally, one more level of transformation of <code>co_await</code> statements, coroutine would look like:</p></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-3-1><a class=lnlinks href=#hl-3-1> 1</a>
</span><span class=lnt id=hl-3-2><a class=lnlinks href=#hl-3-2> 2</a>
</span><span class=lnt id=hl-3-3><a class=lnlinks href=#hl-3-3> 3</a>
</span><span class=lnt id=hl-3-4><a class=lnlinks href=#hl-3-4> 4</a>
</span><span class=lnt id=hl-3-5><a class=lnlinks href=#hl-3-5> 5</a>
</span><span class=lnt id=hl-3-6><a class=lnlinks href=#hl-3-6> 6</a>
</span><span class=lnt id=hl-3-7><a class=lnlinks href=#hl-3-7> 7</a>
</span><span class=lnt id=hl-3-8><a class=lnlinks href=#hl-3-8> 8</a>
</span><span class=lnt id=hl-3-9><a class=lnlinks href=#hl-3-9> 9</a>
</span><span class=lnt id=hl-3-10><a class=lnlinks href=#hl-3-10>10</a>
</span><span class=lnt id=hl-3-11><a class=lnlinks href=#hl-3-11>11</a>
</span><span class=lnt id=hl-3-12><a class=lnlinks href=#hl-3-12>12</a>
</span><span class=lnt id=hl-3-13><a class=lnlinks href=#hl-3-13>13</a>
</span><span class=lnt id=hl-3-14><a class=lnlinks href=#hl-3-14>14</a>
</span><span class=lnt id=hl-3-15><a class=lnlinks href=#hl-3-15>15</a>
</span><span class=lnt id=hl-3-16><a class=lnlinks href=#hl-3-16>16</a>
</span><span class=lnt id=hl-3-17><a class=lnlinks href=#hl-3-17>17</a>
</span><span class=lnt id=hl-3-18><a class=lnlinks href=#hl-3-18>18</a>
</span><span class=lnt id=hl-3-19><a class=lnlinks href=#hl-3-19>19</a>
</span><span class=lnt id=hl-3-20><a class=lnlinks href=#hl-3-20>20</a>
</span><span class=lnt id=hl-3-21><a class=lnlinks href=#hl-3-21>21</a>
</span><span class=lnt id=hl-3-22><a class=lnlinks href=#hl-3-22>22</a>
</span><span class=lnt id=hl-3-23><a class=lnlinks href=#hl-3-23>23</a>
</span><span class=lnt id=hl-3-24><a class=lnlinks href=#hl-3-24>24</a>
</span><span class=lnt id=hl-3-25><a class=lnlinks href=#hl-3-25>25</a>
</span><span class=lnt id=hl-3-26><a class=lnlinks href=#hl-3-26>26</a>
</span><span class=lnt id=hl-3-27><a class=lnlinks href=#hl-3-27>27</a>
</span><span class=lnt id=hl-3-28><a class=lnlinks href=#hl-3-28>28</a>
</span><span class=lnt id=hl-3-29><a class=lnlinks href=#hl-3-29>29</a>
</span><span class=lnt id=hl-3-30><a class=lnlinks href=#hl-3-30>30</a>
</span><span class=lnt id=hl-3-31><a class=lnlinks href=#hl-3-31>31</a>
</span><span class=lnt id=hl-3-32><a class=lnlinks href=#hl-3-32>32</a>
</span><span class=lnt id=hl-3-33><a class=lnlinks href=#hl-3-33>33</a>
</span><span class=lnt id=hl-3-34><a class=lnlinks href=#hl-3-34>34</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=n>HelloWorldCoro</span> <span class=nf>print_hello_world</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>__HelloWorldCoro_ctx</span><span class=o>*</span> <span class=n>__context</span> <span class=o>=</span> <span class=k>new</span> <span class=n>__HelloWorldCoro_ctx</span><span class=p>{};</span>
</span></span><span class=line><span class=cl>    <span class=k>auto</span> <span class=n>__return</span> <span class=o>=</span> <span class=n>__context</span><span class=o>-&gt;</span><span class=n>_promise</span><span class=p>.</span><span class=n>get_return_object</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>auto</span><span class=o>&amp;&amp;</span> <span class=n>awaiter</span> <span class=o>=</span> <span class=n>std</span><span class=o>::</span><span class=n>suspend_always</span><span class=p>{};</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>awaiter</span><span class=p>.</span><span class=n>await_ready</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>awaiter</span><span class=p>.</span><span class=n>await_suspend</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>coroutine_handle</span><span class=o>&lt;&gt;</span> <span class=n>p</span><span class=p>);</span> 
</span></span><span class=line><span class=cl>            <span class=c1>// compiler added suspend/resume hook
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>awaiter</span><span class=p>.</span><span class=n>await_resume</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;Hello &#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>auto</span><span class=o>&amp;&amp;</span> <span class=n>awaiter</span> <span class=o>=</span> <span class=n>std</span><span class=o>::</span><span class=n>suspend_always</span><span class=p>{};</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>awaiter</span><span class=p>.</span><span class=n>await_ready</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>awaiter</span><span class=p>.</span><span class=n>await_suspend</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>coroutine_handle</span><span class=o>&lt;&gt;</span> <span class=n>p</span><span class=p>);</span> 
</span></span><span class=line><span class=cl>            <span class=c1>// compiler added suspend/resume hook
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>awaiter</span><span class=p>.</span><span class=n>await_resume</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;World!&#34;</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nl>__final_suspend_label</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>auto</span><span class=o>&amp;&amp;</span> <span class=n>awaiter</span> <span class=o>=</span> <span class=n>std</span><span class=o>::</span><span class=n>suspend_always</span><span class=p>{};</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>awaiter</span><span class=p>.</span><span class=n>await_ready</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>awaiter</span><span class=p>.</span><span class=n>await_suspend</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>coroutine_handle</span><span class=o>&lt;&gt;</span> <span class=n>p</span><span class=p>);</span> 
</span></span><span class=line><span class=cl>            <span class=c1>// compiler added suspend/resume hook
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>awaiter</span><span class=p>.</span><span class=n>await_resume</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>__return</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><p>As you can see our <code>HelloWorldCoro::promise_type::initial_suspend()</code><br>& <code>HelloWorldCoro::promise_type::final_suspend()</code>returns <code>std::suspend_always</code>. </p></li><li><p>Whose, method <code>std::suspend_always::await_ready()</code>in turn returns <code>false</code> always. </p></li><li><p>So our coroutine will be suspended every time it encounters <code>co_await</code>.</p></li></ul><h3 id=returning-a-value-from-coroutine>Returning a Value From Coroutine<a hidden class=anchor aria-hidden=true href=#returning-a-value-from-coroutine>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-4-1><a class=lnlinks href=#hl-4-1> 1</a>
</span><span class=lnt id=hl-4-2><a class=lnlinks href=#hl-4-2> 2</a>
</span><span class=lnt id=hl-4-3><a class=lnlinks href=#hl-4-3> 3</a>
</span><span class=lnt id=hl-4-4><a class=lnlinks href=#hl-4-4> 4</a>
</span><span class=lnt id=hl-4-5><a class=lnlinks href=#hl-4-5> 5</a>
</span><span class=lnt id=hl-4-6><a class=lnlinks href=#hl-4-6> 6</a>
</span><span class=lnt id=hl-4-7><a class=lnlinks href=#hl-4-7> 7</a>
</span><span class=lnt id=hl-4-8><a class=lnlinks href=#hl-4-8> 8</a>
</span><span class=lnt id=hl-4-9><a class=lnlinks href=#hl-4-9> 9</a>
</span><span class=lnt id=hl-4-10><a class=lnlinks href=#hl-4-10>10</a>
</span><span class=lnt id=hl-4-11><a class=lnlinks href=#hl-4-11>11</a>
</span><span class=lnt id=hl-4-12><a class=lnlinks href=#hl-4-12>12</a>
</span><span class=lnt id=hl-4-13><a class=lnlinks href=#hl-4-13>13</a>
</span><span class=lnt id=hl-4-14><a class=lnlinks href=#hl-4-14>14</a>
</span><span class=lnt id=hl-4-15><a class=lnlinks href=#hl-4-15>15</a>
</span><span class=lnt id=hl-4-16><a class=lnlinks href=#hl-4-16>16</a>
</span><span class=lnt id=hl-4-17><a class=lnlinks href=#hl-4-17>17</a>
</span><span class=lnt id=hl-4-18><a class=lnlinks href=#hl-4-18>18</a>
</span><span class=lnt id=hl-4-19><a class=lnlinks href=#hl-4-19>19</a>
</span><span class=lnt id=hl-4-20><a class=lnlinks href=#hl-4-20>20</a>
</span><span class=lnt id=hl-4-21><a class=lnlinks href=#hl-4-21>21</a>
</span><span class=lnt id=hl-4-22><a class=lnlinks href=#hl-4-22>22</a>
</span><span class=lnt id=hl-4-23><a class=lnlinks href=#hl-4-23>23</a>
</span><span class=lnt id=hl-4-24><a class=lnlinks href=#hl-4-24>24</a>
</span><span class=lnt id=hl-4-25><a class=lnlinks href=#hl-4-25>25</a>
</span><span class=lnt id=hl-4-26><a class=lnlinks href=#hl-4-26>26</a>
</span><span class=lnt id=hl-4-27><a class=lnlinks href=#hl-4-27>27</a>
</span><span class=lnt id=hl-4-28><a class=lnlinks href=#hl-4-28>28</a>
</span><span class=lnt id=hl-4-29><a class=lnlinks href=#hl-4-29>29</a>
</span><span class=lnt id=hl-4-30><a class=lnlinks href=#hl-4-30>30</a>
</span><span class=lnt id=hl-4-31><a class=lnlinks href=#hl-4-31>31</a>
</span><span class=lnt id=hl-4-32><a class=lnlinks href=#hl-4-32>32</a>
</span><span class=lnt id=hl-4-33><a class=lnlinks href=#hl-4-33>33</a>
</span><span class=lnt id=hl-4-34><a class=lnlinks href=#hl-4-34>34</a>
</span><span class=lnt id=hl-4-35><a class=lnlinks href=#hl-4-35>35</a>
</span><span class=lnt id=hl-4-36><a class=lnlinks href=#hl-4-36>36</a>
</span><span class=lnt id=hl-4-37><a class=lnlinks href=#hl-4-37>37</a>
</span><span class=lnt id=hl-4-38><a class=lnlinks href=#hl-4-38>38</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;coroutine&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;iostream&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;cassert&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=nc>HelloWorldCoro</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=nc>promise_type</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>m_value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>HelloWorldCoro</span> <span class=nf>get_return_object</span><span class=p>()</span> <span class=p>{</span> <span class=k>return</span> <span class=k>this</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>std</span><span class=o>::</span><span class=n>suspend_always</span> <span class=n>initial_suspend</span><span class=p>()</span> <span class=p>{</span> <span class=k>return</span> <span class=p>{};</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>std</span><span class=o>::</span><span class=n>suspend_always</span> <span class=n>final_suspend</span><span class=p>()</span> <span class=p>{</span> <span class=k>return</span> <span class=p>{};</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kt>void</span> <span class=nf>return_value</span><span class=p>(</span><span class=kt>int</span> <span class=n>val</span><span class=p>)</span> <span class=p>{</span> <span class=n>m_value</span> <span class=o>=</span> <span class=n>val</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>HelloWorldCoro</span><span class=p>(</span><span class=n>promise_type</span><span class=o>*</span> <span class=n>p</span><span class=p>)</span> <span class=o>:</span> <span class=n>m_handle</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>coroutine_handle</span><span class=o>&lt;</span><span class=n>promise_type</span><span class=o>&gt;::</span><span class=n>from_promise</span><span class=p>(</span><span class=o>*</span><span class=n>p</span><span class=p>))</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=o>~</span><span class=n>HelloWorldCoro</span><span class=p>()</span> <span class=p>{</span> <span class=n>m_handle</span><span class=p>.</span><span class=n>destroy</span><span class=p>();</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>coroutine_handle</span><span class=o>&lt;</span><span class=n>promise_type</span><span class=o>&gt;</span>      <span class=n>m_handle</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>HelloWorldCoro</span> <span class=nf>print_hello_world</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;Hello &#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>co_await</span> <span class=n>std</span><span class=o>::</span><span class=n>suspend_always</span><span class=p>{</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;World!&#34;</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>co_return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>HelloWorldCoro</span> <span class=n>mycoro</span> <span class=o>=</span> <span class=n>print_hello_world</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>mycoro</span><span class=p>.</span><span class=n>m_handle</span><span class=p>.</span><span class=n>resume</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>mycoro</span><span class=p>.</span><span class=n>m_handle</span><span class=p>.</span><span class=n>resume</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>assert</span><span class=p>(</span><span class=n>mycoro</span><span class=p>.</span><span class=n>m_handle</span><span class=p>.</span><span class=n>promise</span><span class=p>().</span><span class=n>m_value</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>EXIT_SUCCESS</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><p>To return a value from a coroutine, you need to supply <code>return_value()</code>method to promise type. In other words, the compiler expects the method named <code>return_value</code> with appropriate argument.</p></li><li><p>And, if you don&rsquo;t supply it to promise type, you will be prompted with the below error:</p></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-5-1><a class=lnlinks href=#hl-5-1>1</a>
</span><span class=lnt id=hl-5-2><a class=lnlinks href=#hl-5-2>2</a>
</span><span class=lnt id=hl-5-3><a class=lnlinks href=#hl-5-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=n>Main</span><span class=p>.</span><span class=nl>cpp</span><span class=p>:</span><span class=mi>27</span><span class=o>:</span><span class=mi>5</span><span class=o>:</span> <span class=nl>error</span><span class=p>:</span> <span class=n>no</span> <span class=n>member</span> <span class=n>named</span> <span class=err>‘</span><span class=n>return_value</span><span class=err>’</span> <span class=n>in</span> <span class=err>‘</span><span class=n>std</span><span class=o>::</span><span class=n>__n4861</span><span class=o>::</span><span class=n>__coroutine_traits_impl</span><span class=o>&lt;</span><span class=n>HelloWorldCoro</span><span class=p>,</span> <span class=kt>void</span><span class=o>&gt;::</span><span class=n>promise_type</span><span class=err>’</span> <span class=p>{</span><span class=n>aka</span> <span class=err>‘</span><span class=n>HelloWorldCoro</span><span class=o>::</span><span class=n>promise_type</span><span class=err>’</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=mi>27</span> <span class=o>|</span>     <span class=k>co_return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>       <span class=o>|</span>     <span class=o>^~~~~~~~~</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>This <code>return_value()</code>method is then used by compiler to transform the <code>co_return</code> statement as below:</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-6-1><a class=lnlinks href=#hl-6-1> 1</a>
</span><span class=lnt id=hl-6-2><a class=lnlinks href=#hl-6-2> 2</a>
</span><span class=lnt id=hl-6-3><a class=lnlinks href=#hl-6-3> 3</a>
</span><span class=lnt id=hl-6-4><a class=lnlinks href=#hl-6-4> 4</a>
</span><span class=lnt id=hl-6-5><a class=lnlinks href=#hl-6-5> 5</a>
</span><span class=lnt id=hl-6-6><a class=lnlinks href=#hl-6-6> 6</a>
</span><span class=lnt id=hl-6-7><a class=lnlinks href=#hl-6-7> 7</a>
</span><span class=lnt id=hl-6-8><a class=lnlinks href=#hl-6-8> 8</a>
</span><span class=lnt id=hl-6-9><a class=lnlinks href=#hl-6-9> 9</a>
</span><span class=lnt id=hl-6-10><a class=lnlinks href=#hl-6-10>10</a>
</span><span class=lnt id=hl-6-11><a class=lnlinks href=#hl-6-11>11</a>
</span><span class=lnt id=hl-6-12><a class=lnlinks href=#hl-6-12>12</a>
</span><span class=lnt id=hl-6-13><a class=lnlinks href=#hl-6-13>13</a>
</span><span class=lnt id=hl-6-14><a class=lnlinks href=#hl-6-14>14</a>
</span><span class=lnt id=hl-6-15><a class=lnlinks href=#hl-6-15>15</a>
</span><span class=lnt id=hl-6-16><a class=lnlinks href=#hl-6-16>16</a>
</span><span class=lnt id=hl-6-17><a class=lnlinks href=#hl-6-17>17</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=n>HelloWorldCoro</span> <span class=nf>print_hello_world</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>__HelloWorldCoro_ctx</span><span class=o>*</span> <span class=n>__context</span> <span class=o>=</span> <span class=k>new</span> <span class=n>__HelloWorldCoro_ctx</span><span class=p>{};</span>
</span></span><span class=line><span class=cl>    <span class=k>auto</span> <span class=n>__return</span> <span class=o>=</span> <span class=n>__context</span><span class=o>-&gt;</span><span class=n>_promise</span><span class=p>.</span><span class=n>get_return_object</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>co_await</span> <span class=n>__context</span><span class=o>-&gt;</span><span class=n>_promise</span><span class=p>.</span><span class=n>initial_suspend</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;Hello &#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>co_await</span> <span class=n>std</span><span class=o>::</span><span class=n>suspend_always</span><span class=p>{</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;World!&#34;</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>__context</span><span class=o>-&gt;</span><span class=n>_promise</span><span class=p>.</span><span class=n>return_value</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>goto</span> <span class=n>__final_suspend_label</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nl>__final_suspend_label</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>co_await</span> <span class=n>__context</span><span class=o>-&gt;</span><span class=n>_promise</span><span class=p>.</span><span class=n>final_suspend</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>delete</span> <span class=n>__context</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>__return</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><p>As you might have noticed, <code>co_return</code> transformation is plain vanilla, where the compiler just passes the return value to the promise object & jump to the final suspend label.</p></li><li><p>I will not expand the <code>co_await</code> statements again. Otherwise, the code will become messy. However, by now, you can guess what could be there.</p></li></ul><h3 id=yielding-a-value-from-coroutine>Yielding a Value From Coroutine<a hidden class=anchor aria-hidden=true href=#yielding-a-value-from-coroutine>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-7-1><a class=lnlinks href=#hl-7-1> 1</a>
</span><span class=lnt id=hl-7-2><a class=lnlinks href=#hl-7-2> 2</a>
</span><span class=lnt id=hl-7-3><a class=lnlinks href=#hl-7-3> 3</a>
</span><span class=lnt id=hl-7-4><a class=lnlinks href=#hl-7-4> 4</a>
</span><span class=lnt id=hl-7-5><a class=lnlinks href=#hl-7-5> 5</a>
</span><span class=lnt id=hl-7-6><a class=lnlinks href=#hl-7-6> 6</a>
</span><span class=lnt id=hl-7-7><a class=lnlinks href=#hl-7-7> 7</a>
</span><span class=lnt id=hl-7-8><a class=lnlinks href=#hl-7-8> 8</a>
</span><span class=lnt id=hl-7-9><a class=lnlinks href=#hl-7-9> 9</a>
</span><span class=lnt id=hl-7-10><a class=lnlinks href=#hl-7-10>10</a>
</span><span class=lnt id=hl-7-11><a class=lnlinks href=#hl-7-11>11</a>
</span><span class=lnt id=hl-7-12><a class=lnlinks href=#hl-7-12>12</a>
</span><span class=lnt id=hl-7-13><a class=lnlinks href=#hl-7-13>13</a>
</span><span class=lnt id=hl-7-14><a class=lnlinks href=#hl-7-14>14</a>
</span><span class=lnt id=hl-7-15><a class=lnlinks href=#hl-7-15>15</a>
</span><span class=lnt id=hl-7-16><a class=lnlinks href=#hl-7-16>16</a>
</span><span class=lnt id=hl-7-17><a class=lnlinks href=#hl-7-17>17</a>
</span><span class=lnt id=hl-7-18><a class=lnlinks href=#hl-7-18>18</a>
</span><span class=lnt id=hl-7-19><a class=lnlinks href=#hl-7-19>19</a>
</span><span class=lnt id=hl-7-20><a class=lnlinks href=#hl-7-20>20</a>
</span><span class=lnt id=hl-7-21><a class=lnlinks href=#hl-7-21>21</a>
</span><span class=lnt id=hl-7-22><a class=lnlinks href=#hl-7-22>22</a>
</span><span class=lnt id=hl-7-23><a class=lnlinks href=#hl-7-23>23</a>
</span><span class=lnt id=hl-7-24><a class=lnlinks href=#hl-7-24>24</a>
</span><span class=lnt id=hl-7-25><a class=lnlinks href=#hl-7-25>25</a>
</span><span class=lnt id=hl-7-26><a class=lnlinks href=#hl-7-26>26</a>
</span><span class=lnt id=hl-7-27><a class=lnlinks href=#hl-7-27>27</a>
</span><span class=lnt id=hl-7-28><a class=lnlinks href=#hl-7-28>28</a>
</span><span class=lnt id=hl-7-29><a class=lnlinks href=#hl-7-29>29</a>
</span><span class=lnt id=hl-7-30><a class=lnlinks href=#hl-7-30>30</a>
</span><span class=lnt id=hl-7-31><a class=lnlinks href=#hl-7-31>31</a>
</span><span class=lnt id=hl-7-32><a class=lnlinks href=#hl-7-32>32</a>
</span><span class=lnt id=hl-7-33><a class=lnlinks href=#hl-7-33>33</a>
</span><span class=lnt id=hl-7-34><a class=lnlinks href=#hl-7-34>34</a>
</span><span class=lnt id=hl-7-35><a class=lnlinks href=#hl-7-35>35</a>
</span><span class=lnt id=hl-7-36><a class=lnlinks href=#hl-7-36>36</a>
</span><span class=lnt id=hl-7-37><a class=lnlinks href=#hl-7-37>37</a>
</span><span class=lnt id=hl-7-38><a class=lnlinks href=#hl-7-38>38</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;coroutine&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;iostream&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;cassert&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=nc>HelloWorldCoro</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=nc>promise_type</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>m_val</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>HelloWorldCoro</span> <span class=nf>get_return_object</span><span class=p>()</span> <span class=p>{</span> <span class=k>return</span> <span class=k>this</span><span class=p>;</span> <span class=p>}</span> 
</span></span><span class=line><span class=cl>        <span class=n>std</span><span class=o>::</span><span class=n>suspend_always</span> <span class=n>initial_suspend</span><span class=p>()</span> <span class=p>{</span> <span class=k>return</span> <span class=p>{};</span> <span class=p>}</span> 
</span></span><span class=line><span class=cl>        <span class=n>std</span><span class=o>::</span><span class=n>suspend_always</span> <span class=n>final_suspend</span><span class=p>()</span> <span class=p>{</span> <span class=k>return</span> <span class=p>{};</span> <span class=p>}</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>std</span><span class=o>::</span><span class=n>suspend_always</span> <span class=n>yield_value</span><span class=p>(</span><span class=kt>int</span> <span class=n>val</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>m_val</span> <span class=o>=</span> <span class=n>val</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>HelloWorldCoro</span><span class=p>(</span><span class=n>promise_type</span><span class=o>*</span> <span class=n>p</span><span class=p>)</span> <span class=o>:</span> <span class=n>m_handle</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>coroutine_handle</span><span class=o>&lt;</span><span class=n>promise_type</span><span class=o>&gt;::</span><span class=n>from_promise</span><span class=p>(</span><span class=o>*</span><span class=n>p</span><span class=p>))</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=o>~</span><span class=n>HelloWorldCoro</span><span class=p>()</span> <span class=p>{</span> <span class=n>m_handle</span><span class=p>.</span><span class=n>destroy</span><span class=p>();</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>coroutine_handle</span><span class=o>&lt;</span><span class=n>promise_type</span><span class=o>&gt;</span>      <span class=n>m_handle</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>HelloWorldCoro</span> <span class=nf>print_hello_world</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;Hello &#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>co_yield</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;World!&#34;</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>HelloWorldCoro</span> <span class=n>mycoro</span> <span class=o>=</span> <span class=n>print_hello_world</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>mycoro</span><span class=p>.</span><span class=n>m_handle</span><span class=p>.</span><span class=n>resume</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>assert</span><span class=p>(</span><span class=n>mycoro</span><span class=p>.</span><span class=n>m_handle</span><span class=p>.</span><span class=n>promise</span><span class=p>().</span><span class=n>m_val</span> <span class=o>==</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>mycoro</span><span class=p>.</span><span class=n>m_handle</span><span class=p>.</span><span class=n>resume</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>EXIT_SUCCESS</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><p>As we have done in returning a value from a coroutine, to yield anything from coroutine you need to supply the <code>yield_value()</code>method to promise_type that returns awaitable type.</p></li><li><p>Once again, the compiler transforms the coroutine that yields as:</p></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-8-1><a class=lnlinks href=#hl-8-1> 1</a>
</span><span class=lnt id=hl-8-2><a class=lnlinks href=#hl-8-2> 2</a>
</span><span class=lnt id=hl-8-3><a class=lnlinks href=#hl-8-3> 3</a>
</span><span class=lnt id=hl-8-4><a class=lnlinks href=#hl-8-4> 4</a>
</span><span class=lnt id=hl-8-5><a class=lnlinks href=#hl-8-5> 5</a>
</span><span class=lnt id=hl-8-6><a class=lnlinks href=#hl-8-6> 6</a>
</span><span class=lnt id=hl-8-7><a class=lnlinks href=#hl-8-7> 7</a>
</span><span class=lnt id=hl-8-8><a class=lnlinks href=#hl-8-8> 8</a>
</span><span class=lnt id=hl-8-9><a class=lnlinks href=#hl-8-9> 9</a>
</span><span class=lnt id=hl-8-10><a class=lnlinks href=#hl-8-10>10</a>
</span><span class=lnt id=hl-8-11><a class=lnlinks href=#hl-8-11>11</a>
</span><span class=lnt id=hl-8-12><a class=lnlinks href=#hl-8-12>12</a>
</span><span class=lnt id=hl-8-13><a class=lnlinks href=#hl-8-13>13</a>
</span><span class=lnt id=hl-8-14><a class=lnlinks href=#hl-8-14>14</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=n>HelloWorldCoro</span> <span class=nf>print_hello_world</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>__HelloWorldCoro_ctx</span><span class=o>*</span> <span class=n>__context</span> <span class=o>=</span> <span class=k>new</span> <span class=n>__HelloWorldCoro_ctx</span><span class=p>{};</span>
</span></span><span class=line><span class=cl>    <span class=k>auto</span> <span class=n>__return</span> <span class=o>=</span> <span class=n>__context</span><span class=o>-&gt;</span><span class=n>_promise</span><span class=p>.</span><span class=n>get_return_object</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>co_await</span> <span class=n>__context</span><span class=o>-&gt;</span><span class=n>_promise</span><span class=p>.</span><span class=n>initial_suspend</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;Hello &#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>co_await</span> <span class=n>__context</span><span class=o>-&gt;</span><span class=n>_promise</span><span class=p>.</span><span class=n>yield_value</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;World!&#34;</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nl>__final_suspend_label</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>co_await</span> <span class=n>__context</span><span class=o>-&gt;</span><span class=n>_promise</span><span class=p>.</span><span class=n>final_suspend</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>delete</span> <span class=n>__context</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>__return</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>As you can see <code>co_yield</code> statement transformed into <code>co_await</code> considering the promise&rsquo;s method(i.e. <code>yield_value()</code> call as expression. That returns <code>std::suspend_always</code> so our coroutine will be suspended thereafter yielding a value.</li></ul><h2 id=generating-integer-sequence-using-c20-coroutine>Generating Integer Sequence Using C++20 Coroutine<a hidden class=anchor aria-hidden=true href=#generating-integer-sequence-using-c20-coroutine>#</a></h2><ul><li>So, that we understood the compiler transformations of coroutine, let&rsquo;s do something meaningful with coroutine.</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-9-1><a class=lnlinks href=#hl-9-1> 1</a>
</span><span class=lnt id=hl-9-2><a class=lnlinks href=#hl-9-2> 2</a>
</span><span class=lnt id=hl-9-3><a class=lnlinks href=#hl-9-3> 3</a>
</span><span class=lnt id=hl-9-4><a class=lnlinks href=#hl-9-4> 4</a>
</span><span class=lnt id=hl-9-5><a class=lnlinks href=#hl-9-5> 5</a>
</span><span class=lnt id=hl-9-6><a class=lnlinks href=#hl-9-6> 6</a>
</span><span class=lnt id=hl-9-7><a class=lnlinks href=#hl-9-7> 7</a>
</span><span class=lnt id=hl-9-8><a class=lnlinks href=#hl-9-8> 8</a>
</span><span class=lnt id=hl-9-9><a class=lnlinks href=#hl-9-9> 9</a>
</span><span class=lnt id=hl-9-10><a class=lnlinks href=#hl-9-10>10</a>
</span><span class=lnt id=hl-9-11><a class=lnlinks href=#hl-9-11>11</a>
</span><span class=lnt id=hl-9-12><a class=lnlinks href=#hl-9-12>12</a>
</span><span class=lnt id=hl-9-13><a class=lnlinks href=#hl-9-13>13</a>
</span><span class=lnt id=hl-9-14><a class=lnlinks href=#hl-9-14>14</a>
</span><span class=lnt id=hl-9-15><a class=lnlinks href=#hl-9-15>15</a>
</span><span class=lnt id=hl-9-16><a class=lnlinks href=#hl-9-16>16</a>
</span><span class=lnt id=hl-9-17><a class=lnlinks href=#hl-9-17>17</a>
</span><span class=lnt id=hl-9-18><a class=lnlinks href=#hl-9-18>18</a>
</span><span class=lnt id=hl-9-19><a class=lnlinks href=#hl-9-19>19</a>
</span><span class=lnt id=hl-9-20><a class=lnlinks href=#hl-9-20>20</a>
</span><span class=lnt id=hl-9-21><a class=lnlinks href=#hl-9-21>21</a>
</span><span class=lnt id=hl-9-22><a class=lnlinks href=#hl-9-22>22</a>
</span><span class=lnt id=hl-9-23><a class=lnlinks href=#hl-9-23>23</a>
</span><span class=lnt id=hl-9-24><a class=lnlinks href=#hl-9-24>24</a>
</span><span class=lnt id=hl-9-25><a class=lnlinks href=#hl-9-25>25</a>
</span><span class=lnt id=hl-9-26><a class=lnlinks href=#hl-9-26>26</a>
</span><span class=lnt id=hl-9-27><a class=lnlinks href=#hl-9-27>27</a>
</span><span class=lnt id=hl-9-28><a class=lnlinks href=#hl-9-28>28</a>
</span><span class=lnt id=hl-9-29><a class=lnlinks href=#hl-9-29>29</a>
</span><span class=lnt id=hl-9-30><a class=lnlinks href=#hl-9-30>30</a>
</span><span class=lnt id=hl-9-31><a class=lnlinks href=#hl-9-31>31</a>
</span><span class=lnt id=hl-9-32><a class=lnlinks href=#hl-9-32>32</a>
</span><span class=lnt id=hl-9-33><a class=lnlinks href=#hl-9-33>33</a>
</span><span class=lnt id=hl-9-34><a class=lnlinks href=#hl-9-34>34</a>
</span><span class=lnt id=hl-9-35><a class=lnlinks href=#hl-9-35>35</a>
</span><span class=lnt id=hl-9-36><a class=lnlinks href=#hl-9-36>36</a>
</span><span class=lnt id=hl-9-37><a class=lnlinks href=#hl-9-37>37</a>
</span><span class=lnt id=hl-9-38><a class=lnlinks href=#hl-9-38>38</a>
</span><span class=lnt id=hl-9-39><a class=lnlinks href=#hl-9-39>39</a>
</span><span class=lnt id=hl-9-40><a class=lnlinks href=#hl-9-40>40</a>
</span><span class=lnt id=hl-9-41><a class=lnlinks href=#hl-9-41>41</a>
</span><span class=lnt id=hl-9-42><a class=lnlinks href=#hl-9-42>42</a>
</span><span class=lnt id=hl-9-43><a class=lnlinks href=#hl-9-43>43</a>
</span><span class=lnt id=hl-9-44><a class=lnlinks href=#hl-9-44>44</a>
</span><span class=lnt id=hl-9-45><a class=lnlinks href=#hl-9-45>45</a>
</span><span class=lnt id=hl-9-46><a class=lnlinks href=#hl-9-46>46</a>
</span><span class=lnt id=hl-9-47><a class=lnlinks href=#hl-9-47>47</a>
</span><span class=lnt id=hl-9-48><a class=lnlinks href=#hl-9-48>48</a>
</span><span class=lnt id=hl-9-49><a class=lnlinks href=#hl-9-49>49</a>
</span><span class=lnt id=hl-9-50><a class=lnlinks href=#hl-9-50>50</a>
</span><span class=lnt id=hl-9-51><a class=lnlinks href=#hl-9-51>51</a>
</span><span class=lnt id=hl-9-52><a class=lnlinks href=#hl-9-52>52</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;coroutine&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;iostream&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;cassert&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=nc>Generator</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=nc>promise_type</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>m_val</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>Generator</span> <span class=nf>get_return_object</span><span class=p>()</span> <span class=p>{</span> <span class=k>return</span> <span class=k>this</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>std</span><span class=o>::</span><span class=n>suspend_never</span> <span class=n>initial_suspend</span><span class=p>()</span> <span class=p>{</span> <span class=k>return</span> <span class=p>{};</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>std</span><span class=o>::</span><span class=n>suspend_always</span> <span class=n>final_suspend</span><span class=p>()</span> <span class=p>{</span> <span class=k>return</span> <span class=p>{};</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>std</span><span class=o>::</span><span class=n>suspend_always</span> <span class=n>yield_value</span><span class=p>(</span><span class=kt>int</span> <span class=n>val</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>m_val</span> <span class=o>=</span> <span class=n>val</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* ---------------------------- Iterator Implementation ----------------------------- */</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=nc>iterator</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>bool</span> <span class=k>operator</span><span class=o>!=</span><span class=p>(</span><span class=k>const</span> <span class=n>iterator</span><span class=o>&amp;</span> <span class=n>rhs</span><span class=p>)</span> <span class=p>{</span> <span class=k>return</span> <span class=n>not</span> <span class=n>m_h_ptr</span><span class=o>-&gt;</span><span class=n>done</span><span class=p>();</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>iterator</span><span class=o>&amp;</span> <span class=k>operator</span><span class=o>++</span><span class=p>()</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>            <span class=n>m_h_ptr</span><span class=o>-&gt;</span><span class=n>resume</span><span class=p>();</span> 
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=o>*</span><span class=k>this</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=k>operator</span><span class=o>*</span><span class=p>()</span> <span class=p>{</span> <span class=k>return</span> <span class=n>m_h_ptr</span><span class=o>-&gt;</span><span class=n>promise</span><span class=p>().</span><span class=n>m_val</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>std</span><span class=o>::</span><span class=n>coroutine_handle</span><span class=o>&lt;</span><span class=n>promise_type</span><span class=o>&gt;</span> <span class=o>*</span><span class=n>m_h_ptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>iterator</span> <span class=nf>begin</span><span class=p>()</span> <span class=p>{</span> <span class=k>return</span> <span class=n>iterator</span><span class=p>{</span><span class=o>&amp;</span><span class=n>m_handle</span><span class=p>};</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>iterator</span> <span class=nf>end</span><span class=p>()</span> <span class=p>{</span> <span class=k>return</span> <span class=n>iterator</span><span class=p>{</span><span class=k>nullptr</span><span class=p>};</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=cm>/* ---------------------------------------------------------------------------------- */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>Generator</span><span class=p>(</span><span class=n>promise_type</span><span class=o>*</span> <span class=n>p</span><span class=p>)</span> <span class=o>:</span> <span class=n>m_handle</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>coroutine_handle</span><span class=o>&lt;</span><span class=n>promise_type</span><span class=o>&gt;::</span><span class=n>from_promise</span><span class=p>(</span><span class=o>*</span><span class=n>p</span><span class=p>))</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=o>~</span><span class=n>Generator</span><span class=p>()</span> <span class=p>{</span> <span class=n>m_handle</span><span class=p>.</span><span class=n>destroy</span><span class=p>();</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>coroutine_handle</span><span class=o>&lt;</span><span class=n>promise_type</span><span class=o>&gt;</span>      <span class=n>m_handle</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Generator</span> <span class=nf>range</span><span class=p>(</span><span class=kt>uint32_t</span> <span class=n>start</span><span class=p>,</span> <span class=kt>uint32_t</span> <span class=n>end</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span><span class=p>(</span><span class=n>start</span> <span class=o>!=</span> <span class=n>end</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>co_yield</span> <span class=n>start</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=k>auto</span> <span class=o>&amp;&amp;</span><span class=nl>no</span> <span class=p>:</span> <span class=n>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>10</span><span class=p>))</span> <span class=p>{</span>  <span class=c1>// Isn&#39;t this look like Python !
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=o>&lt;&lt;</span> <span class=n>no</span> <span class=o>&lt;&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>EXIT_SUCCESS</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><p>A <code>range()</code>function of the above code will generate the integers on every iteration on a need basis. Instead of generating & returning precomputed sequence.</p></li><li><p>For the rest of the code, I suggest you spend some time with patience. And play around it.</p></li><li><p>And, If you are thinking that why do we need <code>iterator</code> implementation inside <code>Generator</code>, then please learn <a href="https://cppinsights.io/lnk?code=I2luY2x1ZGUgPGNzdGRpbz4KCmludCBtYWluKCkKewogICAgY29uc3QgY2hhciBhcnJbXXsyLDQsNiw4LDEwfTsKCiAgICBmb3IoY29uc3QgY2hhciYgYyA6IGFycikKICAgIHsKICAgICAgcHJpbnRmKCJjPSVjXG4iLCBjKTsKICAgIH0KfQ==&amp;std=cpp17&amp;rev=1.0">How Range Based `for` Loop Works In C++!</a>.</p></li></ul><h2 id=c20coroutine-terminology>C++20 Coroutine Terminology<a hidden class=anchor aria-hidden=true href=#c20coroutine-terminology>#</a></h2><ul><li><p>This section should have been at beginning of the article. However, I believe that until you understand how coroutine works under the hood, you won&rsquo;t be able to connect the dots on C++20 coroutine jargons( or won&rsquo;t understand data type naming convention).</p></li><li><p>By this time you are able to write a C++ coroutine & you can ignore this section. Nonetheless, it is just that you will have a hard time communicating with fellow C++ developers & reading <a href=https://en.cppreference.com/w/>cppreference</a>. If you do so.</p></li></ul><h3 id=awaitable>Awaitable<a hidden class=anchor aria-hidden=true href=#awaitable>#</a></h3><ul><li><p>A type that supports the <code>co_await</code> operator is called an Awaitable type.</p></li><li><p>C++20 introduced a new unary operator <code>co_await</code> that can be applied to an expression. For example:</p></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-10-1><a class=lnlinks href=#hl-10-1>1</a>
</span><span class=lnt id=hl-10-2><a class=lnlinks href=#hl-10-2>2</a>
</span><span class=lnt id=hl-10-3><a class=lnlinks href=#hl-10-3>3</a>
</span><span class=lnt id=hl-10-4><a class=lnlinks href=#hl-10-4>4</a>
</span><span class=lnt id=hl-10-5><a class=lnlinks href=#hl-10-5>5</a>
</span><span class=lnt id=hl-10-6><a class=lnlinks href=#hl-10-6>6</a>
</span><span class=lnt id=hl-10-7><a class=lnlinks href=#hl-10-7>7</a>
</span><span class=lnt id=hl-10-8><a class=lnlinks href=#hl-10-8>8</a>
</span><span class=lnt id=hl-10-9><a class=lnlinks href=#hl-10-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>struct</span> <span class=nc>dummy</span> <span class=p>{</span> <span class=c1>// Awaitable
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>std</span><span class=o>::</span><span class=n>suspend_always</span> <span class=k>operator</span> <span class=k>co_await</span><span class=p>(){</span> <span class=k>return</span> <span class=p>{};</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>HelloWorldCoro</span> <span class=nf>print_hello_world</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;Hello &#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>co_await</span> <span class=n>dummy</span><span class=p>{};</span> 
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;World!&#34;</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=awaiter>Awaiter<a hidden class=anchor aria-hidden=true href=#awaiter>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-11-1><a class=lnlinks href=#hl-11-1> 1</a>
</span><span class=lnt id=hl-11-2><a class=lnlinks href=#hl-11-2> 2</a>
</span><span class=lnt id=hl-11-3><a class=lnlinks href=#hl-11-3> 3</a>
</span><span class=lnt id=hl-11-4><a class=lnlinks href=#hl-11-4> 4</a>
</span><span class=lnt id=hl-11-5><a class=lnlinks href=#hl-11-5> 5</a>
</span><span class=lnt id=hl-11-6><a class=lnlinks href=#hl-11-6> 6</a>
</span><span class=lnt id=hl-11-7><a class=lnlinks href=#hl-11-7> 7</a>
</span><span class=lnt id=hl-11-8><a class=lnlinks href=#hl-11-8> 8</a>
</span><span class=lnt id=hl-11-9><a class=lnlinks href=#hl-11-9> 9</a>
</span><span class=lnt id=hl-11-10><a class=lnlinks href=#hl-11-10>10</a>
</span><span class=lnt id=hl-11-11><a class=lnlinks href=#hl-11-11>11</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>struct</span> <span class=nc>my_awaiter</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>bool</span> <span class=nf>await_ready</span><span class=p>()</span> <span class=p>{</span> <span class=k>return</span> <span class=nb>false</span><span class=p>;</span> <span class=p>}</span> 
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>await_suspend</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>coroutine_handle</span><span class=o>&lt;&gt;</span><span class=p>)</span> <span class=p>{}</span> 
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>await_resume</span><span class=p>()</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>HelloWorldCoro</span> <span class=nf>print_hello_world</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;Hello &#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>co_await</span> <span class=n>my_awaiter</span><span class=p>{};</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;World!&#34;</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><p>An Awaiter type is a type that implements the three special methods that are called as part of a <code>co_await</code> expression: <code>await_ready(), </code>await_suspend() and <code>await_resume()</code> For example, standard library defined trivial awaiters i.e. <a href=https://github.com/gcc-mirror/gcc/blob/master/libstdc%2B%2B-v3/include/std/coroutine#L313>std::suspend_always</a> & <a href=https://github.com/gcc-mirror/gcc/blob/master/libstdc%2B%2B-v3/include/std/coroutine#L322>std::suspend_never</a>.</p></li><li><p>Note that a type can be both an Awaitable type and an Awaiter type.</p></li></ul><h3 id=co_await><code>co_await</code><a hidden class=anchor aria-hidden=true href=#co_await>#</a></h3><ul><li><code>co_await</code> is a unary operator that suspends a coroutine and returns control to the caller. Its operand is an expression whose type must either define operator <code>co_await</code>, or Awaitable.</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-12-1><a class=lnlinks href=#hl-12-1> 1</a>
</span><span class=lnt id=hl-12-2><a class=lnlinks href=#hl-12-2> 2</a>
</span><span class=lnt id=hl-12-3><a class=lnlinks href=#hl-12-3> 3</a>
</span><span class=lnt id=hl-12-4><a class=lnlinks href=#hl-12-4> 4</a>
</span><span class=lnt id=hl-12-5><a class=lnlinks href=#hl-12-5> 5</a>
</span><span class=lnt id=hl-12-6><a class=lnlinks href=#hl-12-6> 6</a>
</span><span class=lnt id=hl-12-7><a class=lnlinks href=#hl-12-7> 7</a>
</span><span class=lnt id=hl-12-8><a class=lnlinks href=#hl-12-8> 8</a>
</span><span class=lnt id=hl-12-9><a class=lnlinks href=#hl-12-9> 9</a>
</span><span class=lnt id=hl-12-10><a class=lnlinks href=#hl-12-10>10</a>
</span><span class=lnt id=hl-12-11><a class=lnlinks href=#hl-12-11>11</a>
</span><span class=lnt id=hl-12-12><a class=lnlinks href=#hl-12-12>12</a>
</span><span class=lnt id=hl-12-13><a class=lnlinks href=#hl-12-13>13</a>
</span><span class=lnt id=hl-12-14><a class=lnlinks href=#hl-12-14>14</a>
</span><span class=lnt id=hl-12-15><a class=lnlinks href=#hl-12-15>15</a>
</span><span class=lnt id=hl-12-16><a class=lnlinks href=#hl-12-16>16</a>
</span><span class=lnt id=hl-12-17><a class=lnlinks href=#hl-12-17>17</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>struct</span> <span class=nc>dummy</span> <span class=p>{</span> <span class=p>};</span> <span class=c1>// Awaitable
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=nc>HelloWorldCoro</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=nc>promise_type</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// . . .
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>auto</span> <span class=nf>await_transform</span><span class=p>(</span><span class=k>const</span> <span class=n>dummy</span><span class=o>&amp;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>std</span><span class=o>::</span><span class=n>suspend_always</span><span class=p>{};</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=c1>// . . .
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>HelloWorldCoro</span> <span class=nf>print_hello_world</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;Hello &#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>co_await</span> <span class=n>dummy</span><span class=p>{};</span> 
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;World!&#34;</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=promise>Promise<a hidden class=anchor aria-hidden=true href=#promise>#</a></h3><ul><li><p>A type strictly named as <em><code>promise_type</code></em>.</p></li><li><p>The promise object is used inside the coroutine. The coroutine submits its result or exception through this object.</p></li><li><p>The promise type is determined by the compiler from the return type of the coroutine using <a href=https://en.cppreference.com/w/cpp/coroutine/coroutine_traits>std::coroutine_traits</a>.</p></li></ul><h3 id=coroutine-handle>Coroutine Handle<a hidden class=anchor aria-hidden=true href=#coroutine-handle>#</a></h3><ul><li>The coroutine handle used to resume the execution of the coroutine or to destroy the coroutine frame. It does also indicates the status of coroutine using <code>std::coroutine_handle::done()</code>method.</li></ul><h3 id=coroutine-state>Coroutine State<a hidden class=anchor aria-hidden=true href=#coroutine-state>#</a></h3><ul><li>The coroutine state(referred to as a context object) is a compiler-generated, heap-allocated (unless the allocation is optimized out) object that contains<ul><li>Promise object.</li><li>Parameters (all copied by value).</li><li>Local variables.</li><li>Representation of the current suspension point, so that resume knows where to continue and destroy knows what local variables were in scope.</li></ul></li></ul><h2 id=how-does-coroutine-gets-executed>How Does Coroutine Gets Executed!<a hidden class=anchor aria-hidden=true href=#how-does-coroutine-gets-executed>#</a></h2><ul><li><p>Ahh&mldr;! it&rsquo;s time for the real magic!</p></li><li><p>Now, that we saw how the compiler does the magic with coroutine keywords <code>co_await</code>, <code>co_yield</code> & <code>co_return</code>. Let&rsquo;s understand how it gets executed.</p></li><li><p>But, Before, we move forward, let me clarify some points:</p><ol><li><p>C++ Standard doesn&rsquo;t bother about implementation rather it only states behaviour. Hence implementation of the coroutine is completely dependent on the compiler & library writers. To see that, you can check the <a href=https://github.com/gcc-mirror/gcc/blob/master/libstdc%2B%2B-v3/include/std/coroutine#L126>library implementation</a> of <code>std::coroutine_handle::resume()</code>that uses <a href=https://raw.githubusercontent.com/mirrors/gcc/master/gcc/builtins.def>__builtin_coro_resume</a> which is provided by the GCC compiler. Proving that the library & compiler is tightly coupled.</p></li><li><p>With that being said, I have not written any C++ library or compiler in my career. Though I have written/ported the core C library for proprietary architecture. So, whatever you see in this section is just to build your intuition on how coroutine can be implemented. Based on my research & intuition.</p></li></ol></li><li><p>There are two ways I can see this can be done:</p></li></ul><h3 id=hypothesis-1>Hypothesis 1<a hidden class=anchor aria-hidden=true href=#hypothesis-1>#</a></h3><ul><li>For example, If you have defined your coroutine as:</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-13-1><a class=lnlinks href=#hl-13-1>1</a>
</span><span class=lnt id=hl-13-2><a class=lnlinks href=#hl-13-2>2</a>
</span><span class=lnt id=hl-13-3><a class=lnlinks href=#hl-13-3>3</a>
</span><span class=lnt id=hl-13-4><a class=lnlinks href=#hl-13-4>4</a>
</span><span class=lnt id=hl-13-5><a class=lnlinks href=#hl-13-5>5</a>
</span><span class=lnt id=hl-13-6><a class=lnlinks href=#hl-13-6>6</a>
</span><span class=lnt id=hl-13-7><a class=lnlinks href=#hl-13-7>7</a>
</span><span class=lnt id=hl-13-8><a class=lnlinks href=#hl-13-8>8</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=n>HelloWorldCoro</span> <span class=nf>print_hello_world</span><span class=p>(</span><span class=kt>int</span> <span class=n>a</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>b</span> <span class=o>=</span> <span class=mi>10</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>co_await</span> <span class=n>std</span><span class=o>::</span><span class=n>suspend_always</span><span class=p>{};</span>
</span></span><span class=line><span class=cl>    <span class=n>a</span> <span class=o>=</span> <span class=mi>10</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>c</span> <span class=o>=</span> <span class=mi>10</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>co_await</span> <span class=n>std</span><span class=o>::</span><span class=n>suspend_always</span><span class=p>{};</span>
</span></span><span class=line><span class=cl>    <span class=k>co_return</span> <span class=n>a</span> <span class=o>+</span> <span class=n>b</span> <span class=o>+</span> <span class=n>c</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><p>Then, operations can be divided into 3 different sections separated by 2 suspension-point(i.e. <code>co_await &lt;expr></code>) as</p><ol><li><p><code>int b = 10;</code></p></li><li><p><code>a = 10; int c = 10;</code></p></li><li><p><code>co_return a + b + c;</code></p></li></ol></li><li><p>Considering these suspension points, then the compiler basically</p><ul><li><p>Rewrite your coroutine into a bit like functions.</p></li><li><p>And create a copy of all local variables as a data member of the coroutine state object.</p></li></ul></li><li><p>You can assume coroutine state object layout as:</p></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-14-1><a class=lnlinks href=#hl-14-1> 1</a>
</span><span class=lnt id=hl-14-2><a class=lnlinks href=#hl-14-2> 2</a>
</span><span class=lnt id=hl-14-3><a class=lnlinks href=#hl-14-3> 3</a>
</span><span class=lnt id=hl-14-4><a class=lnlinks href=#hl-14-4> 4</a>
</span><span class=lnt id=hl-14-5><a class=lnlinks href=#hl-14-5> 5</a>
</span><span class=lnt id=hl-14-6><a class=lnlinks href=#hl-14-6> 6</a>
</span><span class=lnt id=hl-14-7><a class=lnlinks href=#hl-14-7> 7</a>
</span><span class=lnt id=hl-14-8><a class=lnlinks href=#hl-14-8> 8</a>
</span><span class=lnt id=hl-14-9><a class=lnlinks href=#hl-14-9> 9</a>
</span><span class=lnt id=hl-14-10><a class=lnlinks href=#hl-14-10>10</a>
</span><span class=lnt id=hl-14-11><a class=lnlinks href=#hl-14-11>11</a>
</span><span class=lnt id=hl-14-12><a class=lnlinks href=#hl-14-12>12</a>
</span><span class=lnt id=hl-14-13><a class=lnlinks href=#hl-14-13>13</a>
</span><span class=lnt id=hl-14-14><a class=lnlinks href=#hl-14-14>14</a>
</span><span class=lnt id=hl-14-15><a class=lnlinks href=#hl-14-15>15</a>
</span><span class=lnt id=hl-14-16><a class=lnlinks href=#hl-14-16>16</a>
</span><span class=lnt id=hl-14-17><a class=lnlinks href=#hl-14-17>17</a>
</span><span class=lnt id=hl-14-18><a class=lnlinks href=#hl-14-18>18</a>
</span><span class=lnt id=hl-14-19><a class=lnlinks href=#hl-14-19>19</a>
</span><span class=lnt id=hl-14-20><a class=lnlinks href=#hl-14-20>20</a>
</span><span class=lnt id=hl-14-21><a class=lnlinks href=#hl-14-21>21</a>
</span><span class=lnt id=hl-14-22><a class=lnlinks href=#hl-14-22>22</a>
</span><span class=lnt id=hl-14-23><a class=lnlinks href=#hl-14-23>23</a>
</span><span class=lnt id=hl-14-24><a class=lnlinks href=#hl-14-24>24</a>
</span><span class=lnt id=hl-14-25><a class=lnlinks href=#hl-14-25>25</a>
</span><span class=lnt id=hl-14-26><a class=lnlinks href=#hl-14-26>26</a>
</span><span class=lnt id=hl-14-27><a class=lnlinks href=#hl-14-27>27</a>
</span><span class=lnt id=hl-14-28><a class=lnlinks href=#hl-14-28>28</a>
</span><span class=lnt id=hl-14-29><a class=lnlinks href=#hl-14-29>29</a>
</span><span class=lnt id=hl-14-30><a class=lnlinks href=#hl-14-30>30</a>
</span><span class=lnt id=hl-14-31><a class=lnlinks href=#hl-14-31>31</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>struct</span> <span class=nc>print_hello_world</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>print_hello_world</span><span class=p>(</span><span class=kt>int</span> <span class=n>a_</span><span class=p>)</span> <span class=o>:</span> <span class=n>a</span><span class=p>{</span><span class=n>a</span><span class=p>}{}</span> <span class=c1>// Coroutine state object with coroutine arguments
</span></span></span><span class=line><span class=cl><span class=c1></span>    
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>_s1</span><span class=p>(){</span> <span class=c1>// Before suspension point 1 operations
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kt>int</span> <span class=n>b</span> <span class=o>=</span> <span class=mi>10</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>sp</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=c1>// switching call back based on suspension point
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>_s2</span><span class=p>(){</span> <span class=c1>// Operations b/w suspension point 1 &amp; 2 
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>a</span> <span class=o>=</span> <span class=mi>10</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>c</span> <span class=o>=</span> <span class=mi>10</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>sp</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>_s3</span><span class=p>(){</span> <span class=c1>// Operations after suspension point 2 
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>promise</span><span class=p>.</span><span class=n>return_value</span><span class=p>(</span><span class=n>a</span> <span class=o>+</span> <span class=n>b</span> <span class=o>+</span> <span class=n>c</span><span class=p>);</span>  <span class=c1>// After execution, coro_done = true;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>        <span class=n>coro_done</span> <span class=o>=</span> <span class=nb>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>c</span><span class=p>;</span> <span class=c1>// Local variables
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=n>promise_type</span><span class=o>&amp;</span> <span class=n>promise</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=p>(</span><span class=o>*</span><span class=n>s_cb</span><span class=p>)[]</span> <span class=o>=</span> <span class=p>{</span><span class=n>_s1</span><span class=p>,</span> <span class=n>_s2</span><span class=p>,</span> <span class=n>_s3</span><span class=p>};</span> <span class=c1>// suspension point callbacks 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>int</span> <span class=n>sp</span><span class=p>{</span><span class=mi>0</span><span class=p>};</span> <span class=c1>// current suspension point(sp)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>bool</span> <span class=n>coro_done</span><span class=p>{</span><span class=nb>false</span><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>Now, when you call coroutine, you are basically creating a coroutine state object with a similar argument to that of coroutine.</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-15-1><a class=lnlinks href=#hl-15-1>1</a>
</span><span class=lnt id=hl-15-2><a class=lnlinks href=#hl-15-2>2</a>
</span><span class=lnt id=hl-15-3><a class=lnlinks href=#hl-15-3>3</a>
</span><span class=lnt id=hl-15-4><a class=lnlinks href=#hl-15-4>4</a>
</span><span class=lnt id=hl-15-5><a class=lnlinks href=#hl-15-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>auto</span> <span class=n>mycoro</span> <span class=o>=</span> <span class=n>print_hello_world</span><span class=p>(</span><span class=mi>5</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// transform into
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=n>print_hello_world</span>    <span class=nf>mycoro</span><span class=p>(</span><span class=mi>5</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>As you might have guessed, due to rewriting coroutine into tiny functions, we don&rsquo;t need a suspension mechanism anymore. And resumption can be implemented as:</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-16-1><a class=lnlinks href=#hl-16-1>1</a>
</span><span class=lnt id=hl-16-2><a class=lnlinks href=#hl-16-2>2</a>
</span><span class=lnt id=hl-16-3><a class=lnlinks href=#hl-16-3>3</a>
</span><span class=lnt id=hl-16-4><a class=lnlinks href=#hl-16-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=kt>void</span> <span class=n>std</span><span class=o>::</span><span class=n>coroutine_handle</span><span class=o>::</span><span class=n>resume</span><span class=p>()</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=n>not</span> <span class=n>print_hello_world</span><span class=o>::</span><span class=n>coro_done</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>print_hello_world</span><span class=o>::</span><span class=n>s_cb</span><span class=p>[</span><span class=n>sp</span><span class=p>]();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><p>So, when you call resume you are basically calling the suspension-point specific tiny function(technically its method) from a coroutine state object. That implies the creation of two stack frame i.e. <code>std::coroutine_handle::resume()</code>& <code>print_hello_world::_sX()</code>, where <code>X</code> stands for a suspension point number. Consequently not needing a separate stack & using the same stack as the caller. And this is why C++20 coroutines are stackless coroutine & faster.</p></li><li><p>I agree that the above example is not compilable, don&rsquo;t cover edge cases & doesn&rsquo;t consider customized(i.e. awaiter object) coroutine behaviour. But, with the intuition we just built, you can easily create a mental model of coroutine & see the compiler perspective.</p></li><li><p>And to test your intuition capability, just imagine <strong>How you can transform the tiny functions for the coroutine that contains <code>co_await</code> expression in a for loop?</strong></p></li></ul><h3 id=hypothesis-2>Hypothesis 2<a hidden class=anchor aria-hidden=true href=#hypothesis-2>#</a></h3><ul><li>Another usual way you can implement suspension-resumption is with the help of <a href=/posts/coroutine-in-c-language/>context switching APIs</a>. For example, in the expansion of <code>co_wait &lt;expr></code> statement, I have mentioned the comment &ldquo;<em>compiler added suspend/resume hook</em>&rdquo; as below.</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-17-1><a class=lnlinks href=#hl-17-1>1</a>
</span><span class=lnt id=hl-17-2><a class=lnlinks href=#hl-17-2>2</a>
</span><span class=lnt id=hl-17-3><a class=lnlinks href=#hl-17-3>3</a>
</span><span class=lnt id=hl-17-4><a class=lnlinks href=#hl-17-4>4</a>
</span><span class=lnt id=hl-17-5><a class=lnlinks href=#hl-17-5>5</a>
</span><span class=lnt id=hl-17-6><a class=lnlinks href=#hl-17-6>6</a>
</span><span class=lnt id=hl-17-7><a class=lnlinks href=#hl-17-7>7</a>
</span><span class=lnt id=hl-17-8><a class=lnlinks href=#hl-17-8>8</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>auto</span><span class=o>&amp;&amp;</span> <span class=n>awaiter</span> <span class=o>=</span> <span class=n>std</span><span class=o>::</span><span class=n>suspend_always</span><span class=p>{};</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>awaiter</span><span class=p>.</span><span class=n>await_ready</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>awaiter</span><span class=p>.</span><span class=n>await_suspend</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>coroutine_handle</span><span class=o>&lt;&gt;</span> <span class=n>p</span><span class=p>);</span> 
</span></span><span class=line><span class=cl>        <span class=c1>// compiler added suspend/resume hook
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>awaiter</span><span class=p>.</span><span class=n>await_resume</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>This is the place where your compiler adds its secret sauce to your code with <a href=/posts/coroutine-in-c-language/>context switching APIs</a>. And rest is I think easy to imagine if you have read my earlier post <a href=/posts/coroutine-in-c-language/>Coroutine in C Language</a> thoroughly.</li></ul><h2 id=summary>Summary<a hidden class=anchor aria-hidden=true href=#summary>#</a></h2><h3 id=subroutine-vs-coroutine>Subroutine vs Coroutine<a hidden class=anchor aria-hidden=true href=#subroutine-vs-coroutine>#</a></h3><table><thead><tr><th></th><th>Subroutines</th><th>Coroutines</th></tr></thead><tbody><tr><td><strong>call</strong></td><td>calling convention i.e. foo()</td><td>calling convention i.e. foo()</td></tr><tr><td><strong>suspend</strong></td><td>Can&rsquo;t suspend</td><td>co_await/co_yield expression</td></tr><tr><td><strong>resume</strong></td><td>Can&rsquo;t suspend</td><td>coroutine_handle&lt;>::resume()</td></tr><tr><td><strong>return</strong></td><td>return statement</td><td>co_return statement</td></tr></tbody></table><h3 id=compiler-transformation-of-coroutine-related-keywords>Compiler Transformation Of Coroutine Related Keywords<a hidden class=anchor aria-hidden=true href=#compiler-transformation-of-coroutine-related-keywords>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-18-1><a class=lnlinks href=#hl-18-1>1</a>
</span><span class=lnt id=hl-18-2><a class=lnlinks href=#hl-18-2>2</a>
</span><span class=lnt id=hl-18-3><a class=lnlinks href=#hl-18-3>3</a>
</span><span class=lnt id=hl-18-4><a class=lnlinks href=#hl-18-4>4</a>
</span><span class=lnt id=hl-18-5><a class=lnlinks href=#hl-18-5>5</a>
</span><span class=lnt id=hl-18-6><a class=lnlinks href=#hl-18-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>co_return</span> <span class=n>x</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// transforms into
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=n>__promise</span><span class=p>.</span><span class=n>return_value</span><span class=p>(</span><span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>goto</span> <span class=n>__final_suspend_label</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-19-1><a class=lnlinks href=#hl-19-1> 1</a>
</span><span class=lnt id=hl-19-2><a class=lnlinks href=#hl-19-2> 2</a>
</span><span class=lnt id=hl-19-3><a class=lnlinks href=#hl-19-3> 3</a>
</span><span class=lnt id=hl-19-4><a class=lnlinks href=#hl-19-4> 4</a>
</span><span class=lnt id=hl-19-5><a class=lnlinks href=#hl-19-5> 5</a>
</span><span class=lnt id=hl-19-6><a class=lnlinks href=#hl-19-6> 6</a>
</span><span class=lnt id=hl-19-7><a class=lnlinks href=#hl-19-7> 7</a>
</span><span class=lnt id=hl-19-8><a class=lnlinks href=#hl-19-8> 8</a>
</span><span class=lnt id=hl-19-9><a class=lnlinks href=#hl-19-9> 9</a>
</span><span class=lnt id=hl-19-10><a class=lnlinks href=#hl-19-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>co_await</span> <span class=n>y</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// transforms into
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=k>auto</span><span class=o>&amp;&amp;</span> <span class=n>__awaitable</span> <span class=o>=</span> <span class=n>y</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=n>__awaitable</span><span class=p>.</span><span class=n>await_ready</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>__awaitable</span><span class=p>.</span><span class=n>await_suspend</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>// compiler added suspend/resume hook
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=n>__awaitable</span><span class=p>.</span><span class=n>await_resume</span><span class=p>();</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-20-1><a class=lnlinks href=#hl-20-1>1</a>
</span><span class=lnt id=hl-20-2><a class=lnlinks href=#hl-20-2>2</a>
</span><span class=lnt id=hl-20-3><a class=lnlinks href=#hl-20-3>3</a>
</span><span class=lnt id=hl-20-4><a class=lnlinks href=#hl-20-4>4</a>
</span><span class=lnt id=hl-20-5><a class=lnlinks href=#hl-20-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>co_yield</span> <span class=n>z</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// transforms into
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=k>co_await</span> <span class=n>__promise</span><span class=p>.</span><span class=n>yield_value</span><span class=p>(</span><span class=n>z</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=parting-words-with-faqs>Parting Words With FAQs<a hidden class=anchor aria-hidden=true href=#parting-words-with-faqs>#</a></h2><ul><li><p>This is not just it, there are still many things that we haven&rsquo;t explored like exception handling, coroutine calling coroutine, etc.</p></li><li><p>One unusual thing I observed about C++20 Coroutine is, You have to specify the return type even if you don&rsquo;t return anything from the coroutine. IMO, this is unusual & counter-intuitive.</p></li></ul><p><strong>What does it mean by stackfull & stackless coroutine?</strong></p><ul><li>stackfull coroutines need a separate stack to be executed.</li><li>stackless coroutine uses the same stack as of caller.</li></ul><p><strong>Difference between threads & coroutines?</strong></p><ul><li>Coroutines are about your <em>programming model</em> and threads are about your <em>execution model</em>.</li><li>co-routine can still do concurrency without scheduler overhead - it simply manages the context-switching itself.</li><li>Another benefit is the much lower memory usage. With the threaded model, each thread needs to allocate its own stack, and so your memory usage grows linearly with the number of threads you have.</li></ul><p><strong>What does it mean by &ldquo;coroutines are like lightweight threads&rdquo;?</strong></p><ul><li>First of all, coroutines & threads are a different entity. Because coroutine can be stackless & doesn&rsquo;t need OS intervention on schedule, it is lower on memory footprint & faster on execution as compared to thread. With C++, it&rsquo;s, even more, faster if you use <a href=/posts/cpp20-coroutine-under-the-hood/#Hypothesis_1>Hypothesis 1</a>.</li></ul><p><strong>How come C++ coroutine are stackless?</strong></p><ul><li>This is already answered in <a href=/posts/cpp20-coroutine-under-the-hood/#Hypothesis_1>Hypothesis 1</a>. Still one more time.</li><li>The compiler &ldquo;returns&rdquo; a handle to this dynamically allocated coroutine frame to the caller of the coroutine.</li><li>When a caller calls <code>std::coroutine_handle::resume()</code> method, stackframe for <code>std::coroutine_handle::resume()</code> will be created which resumes the coroutine while processing all coroutine data on a dynamically allocated coroutine frame.</li><li>And this is how coroutine is stackless in C++. Because it executes in the current stack only. Instead of a separate coroutine stack.</li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://vishalchovatiya.github.io/tags/awaitable/>Awaitable</a></li><li><a href=https://vishalchovatiya.github.io/tags/awaiter/>Awaiter</a></li><li><a href=https://vishalchovatiya.github.io/tags/c20-coroutine/>C20-Coroutine</a></li><li><a href=https://vishalchovatiya.github.io/tags/c20-coroutine-terminology/>C20-Coroutine-Terminology</a></li><li><a href=https://vishalchovatiya.github.io/tags/co_await/>Co_await</a></li><li><a href=https://vishalchovatiya.github.io/tags/co_return/>Co_return</a></li><li><a href=https://vishalchovatiya.github.io/tags/co_yield/>Co_yield</a></li><li><a href=https://vishalchovatiya.github.io/tags/compiler-transformation-of-c-coroutine-related-keywords/>Compiler-Transformation-of-C-Coroutine-Related-Keywords</a></li><li><a href=https://vishalchovatiya.github.io/tags/coroutine-handle/>Coroutine-Handle</a></li><li><a href=https://vishalchovatiya.github.io/tags/coroutine-state/>Coroutine-State</a></li><li><a href=https://vishalchovatiya.github.io/tags/cpp-coroutine/>Cpp-Coroutine</a></li><li><a href=https://vishalchovatiya.github.io/tags/generating-integer-sequence-using-c20-coroutine/>Generating-Integer-Sequence-Using-C20-Coroutine</a></li><li><a href=https://vishalchovatiya.github.io/tags/how-does-c20-coroutine-gets-executed-2/>How-Does-C20-Coroutine-Gets-Executed-2</a></li><li><a href=https://vishalchovatiya.github.io/tags/promise/>Promise</a></li><li><a href=https://vishalchovatiya.github.io/tags/returning-a-value-from-c-coroutine/>Returning-a-Value-From-C-Coroutine</a></li><li><a href=https://vishalchovatiya.github.io/tags/subroutine/>Subroutine</a></li><li><a href=https://vishalchovatiya.github.io/tags/suspending-a-c-coroutine/>Suspending-a-C-Coroutine</a></li><li><a href=https://vishalchovatiya.github.io/tags/understanding-c20-coroutine-with-examples/>Understanding-C20-Coroutine-With-Examples</a></li><li><a href=https://vishalchovatiya.github.io/tags/what-is-c20-coroutine/>What-Is-C20-Coroutine</a></li><li><a href=https://vishalchovatiya.github.io/tags/what-is-coroutine-in-general/>What-Is-Coroutine-in-General</a></li><li><a href=https://vishalchovatiya.github.io/tags/why-do-you-even-need-coroutine/>Why-Do-You-Even-Need-Coroutine</a></li><li><a href=https://vishalchovatiya.github.io/tags/yielding-a-value-from-c-coroutine/>Yielding-a-Value-From-C-Coroutine</a></li></ul><nav class=paginav><a class=next href=https://vishalchovatiya.github.io/posts/coroutine-in-c-language/><span class=title>Next »</span><br><span>Coroutine in C Language</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share C++20 Coroutine: Under The Hood on x" href="https://x.com/intent/tweet/?text=C%2b%2b20%20Coroutine%3a%20Under%20The%20Hood&amp;url=https%3a%2f%2fvishalchovatiya.github.io%2fposts%2fcpp20-coroutine-under-the-hood%2f&amp;hashtags=awaitable%2cawaiter%2cc20-coroutine%2cc20-coroutine-terminology%2cco_await%2cco_return%2cco_yield%2ccompiler-transformation-of-c-coroutine-related-keywords%2ccoroutine-handle%2ccoroutine-state%2ccpp-coroutine%2cgenerating-integer-sequence-using-c20-coroutine%2chow-does-c20-coroutine-gets-executed-2%2cpromise%2creturning-a-value-from-c-coroutine%2csubroutine%2csuspending-a-c-coroutine%2cunderstanding-c20-coroutine-with-examples%2cwhat-is-c20-coroutine%2cwhat-is-coroutine-in-general%2cwhy-do-you-even-need-coroutine%2cyielding-a-value-from-c-coroutine"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share C++20 Coroutine: Under The Hood on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fvishalchovatiya.github.io%2fposts%2fcpp20-coroutine-under-the-hood%2f&amp;title=C%2b%2b20%20Coroutine%3a%20Under%20The%20Hood&amp;summary=C%2b%2b20%20Coroutine%3a%20Under%20The%20Hood&amp;source=https%3a%2f%2fvishalchovatiya.github.io%2fposts%2fcpp20-coroutine-under-the-hood%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share C++20 Coroutine: Under The Hood on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fvishalchovatiya.github.io%2fposts%2fcpp20-coroutine-under-the-hood%2f&title=C%2b%2b20%20Coroutine%3a%20Under%20The%20Hood"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share C++20 Coroutine: Under The Hood on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fvishalchovatiya.github.io%2fposts%2fcpp20-coroutine-under-the-hood%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share C++20 Coroutine: Under The Hood on whatsapp" href="https://api.whatsapp.com/send?text=C%2b%2b20%20Coroutine%3a%20Under%20The%20Hood%20-%20https%3a%2f%2fvishalchovatiya.github.io%2fposts%2fcpp20-coroutine-under-the-hood%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share C++20 Coroutine: Under The Hood on telegram" href="https://telegram.me/share/url?text=C%2b%2b20%20Coroutine%3a%20Under%20The%20Hood&amp;url=https%3a%2f%2fvishalchovatiya.github.io%2fposts%2fcpp20-coroutine-under-the-hood%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share C++20 Coroutine: Under The Hood on ycombinator" href="https://news.ycombinator.com/submitlink?t=C%2b%2b20%20Coroutine%3a%20Under%20The%20Hood&u=https%3a%2f%2fvishalchovatiya.github.io%2fposts%2fcpp20-coroutine-under-the-hood%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://vishalchovatiya.github.io/>Vishal Chovatiya</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>