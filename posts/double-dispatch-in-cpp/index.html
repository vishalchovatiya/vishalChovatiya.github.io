<!DOCTYPE html>
<html lang="en">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <title>
  Double Dispatch in C&#43;&#43;: Recover Original Type of the Object Pointed by Base Class Pointer · Vishal Chovatiya
</title>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="light dark">




<meta name="author" content="Vishal Chovatiya">
<meta name="description" content="Double Dispatch in C&#43;&#43; is a mechanism that dispatches a function call to different concrete functions depending on the runtime types of two objects involved in the call. In more simple words, its function calling using two different virtual tables of respective two objects. I know this sounds cryptic, but don&rsquo;t worry I will come to double dispatch solution after trying most of the naive solution so that you will come away with the full understanding of concept without having needless confusions.">
<meta name="keywords" content="blog,developer,personal">


  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Double Dispatch in C&#43;&#43;: Recover Original Type of the Object Pointed by Base Class Pointer">
  <meta name="twitter:description" content="Double Dispatch in C&#43;&#43; is a mechanism that dispatches a function call to different concrete functions depending on the runtime types of two objects involved in the call. In more simple words, its function calling using two different virtual tables of respective two objects. I know this sounds cryptic, but don’t worry I will come to double dispatch solution after trying most of the naive solution so that you will come away with the full understanding of concept without having needless confusions.">

<meta property="og:url" content="http://localhost:1313/posts/double-dispatch-in-cpp/">
  <meta property="og:site_name" content="Vishal Chovatiya">
  <meta property="og:title" content="Double Dispatch in C&#43;&#43;: Recover Original Type of the Object Pointed by Base Class Pointer">
  <meta property="og:description" content="Double Dispatch in C&#43;&#43; is a mechanism that dispatches a function call to different concrete functions depending on the runtime types of two objects involved in the call. In more simple words, its function calling using two different virtual tables of respective two objects. I know this sounds cryptic, but don’t worry I will come to double dispatch solution after trying most of the naive solution so that you will come away with the full understanding of concept without having needless confusions.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2020-04-11T00:00:00+00:00">
    <meta property="article:modified_time" content="2020-04-11T00:00:00+00:00">




<link rel="canonical" href="http://localhost:1313/posts/double-dispatch-in-cpp/">


<link rel="preload" href="/fonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/fonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/fonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin>


  
  
  <link rel="stylesheet" href="/css/coder.css" media="screen">








 




<link rel="icon" type="image/svg+xml" href="/images/favicon.svg" sizes="any">
<link rel="icon" type="image/png" href="/images/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/images/favicon-16x16.png" sizes="16x16">

<link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#5bbad5">









</head>




<body class="preload-transitions colorscheme-light">
  

  <main class="wrapper">
    <nav class="navigation">
  <section class="container">
    
    <a class="navigation-title" href="http://localhost:1313/">
      Vishal Chovatiya
    </a>
    
    
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa-solid fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link " href="/posts/">Latest</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="/pages/start-here">Start Here</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="/categories/cpp/">C/C&#43;&#43;</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="/categories/linux-system-programming/">Linux System Programming</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="/categories/misc/">Misc</a>
            </li>
          
        
        
      </ul>
    
  </section>
</nav>


    <div class="content">
      
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">
            <a class="title-link" href="http://localhost:1313/posts/double-dispatch-in-cpp/">
              Double Dispatch in C&#43;&#43;: Recover Original Type of the Object Pointed by Base Class Pointer
            </a>
          </h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fa-solid fa-calendar" aria-hidden="true"></i>
              <time datetime="2020-04-11T00:00:00Z">
                April 11, 2020
              </time>
            </span>
            <span class="reading-time">
              <i class="fa-solid fa-clock" aria-hidden="true"></i>
              10-minute read
            </span>
          </div>
          
          <div class="categories">
  <i class="fa-solid fa-folder" aria-hidden="true"></i>
    <a href="/categories/cpp/">Cpp</a></div>

          
        </div>
      </header>

      <div class="post-content">
        
          <img src="/images/double-dispatch-in-C-visitor-design-pattern-www_vishalchovatiya_com.png" alt="Featured image"/>
        
        <p>Double Dispatch in C++ is a mechanism that dispatches <strong><em>a function call to different concrete functions depending on the runtime types of two objects involved in the call</em></strong>.  In more simple words, its function calling using two different virtual tables of respective two objects. I know this sounds cryptic, but don&rsquo;t worry I will come to double dispatch solution after trying most of the naive solution so that you will come away with the full understanding of concept without having needless confusions.</p>
<h2 id="motivation">
  Motivation
  <a class="heading-link" href="#motivation">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<ul>
<li>At first, a pointer to a base class made sense; you didn’t need to know the actual derived class. So you decided to expose a single collection of base class pointers to your clients like so:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Animal</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">virtual</span> <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">name</span>() <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> AnimalList <span style="color:#f92672">=</span> vector<span style="color:#f92672">&lt;</span>Animal<span style="color:#f92672">*&gt;</span>;
</span></span></code></pre></div><ul>
<li>As you added your first few classes, your assumptions were validated; you never needed to know the actual type.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Cat</span> <span style="color:#f92672">:</span> Animal {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">name</span>() { <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;Cat&#34;</span>; }
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Dog</span> <span style="color:#f92672">:</span> Animal {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">name</span>() { <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;Dog&#34;</span>; }
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><ul>
<li>But the requirements change.</li>
<li>One day the client came to you and said &ldquo;I’m trying to model a person that is afraid of dogs, so they run away when they see one. But they love cats, so they try to pet them when they see them.&rdquo;</li>
<li>Dammit. Now your assumptions are wrong. You do need to know the type. And you’re under pressure to meet a deadline.</li>
</ul>
<h2 id="run-time-type-identification">
  Run-Time Type Identification
  <a class="heading-link" href="#run-time-type-identification">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<ul>
<li>Then you thought &ldquo;Well there’s only two types of animals, this isn’t so bad&rdquo;. So you wrote code like this:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Person</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">ReactTo</span>(Animal <span style="color:#f92672">*</span>_animal) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">dynamic_cast</span><span style="color:#f92672">&lt;</span>Dog <span style="color:#f92672">*&gt;</span>(_animal))
</span></span><span style="display:flex;"><span>            RunAwayFrom(_animal);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">dynamic_cast</span><span style="color:#f92672">&lt;</span>Cat <span style="color:#f92672">*&gt;</span>(_animal))
</span></span><span style="display:flex;"><span>            TryToPet(_animal);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">RunAwayFrom</span>(Animal <span style="color:#f92672">*</span>_animal) { cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;Run Away From &#34;</span> <span style="color:#f92672">&lt;&lt;</span> _animal<span style="color:#f92672">-&gt;</span>name() <span style="color:#f92672">&lt;&lt;</span> endl; }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">TryToPet</span>(Animal <span style="color:#f92672">*</span>_animal) { cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;Try To Pet &#34;</span> <span style="color:#f92672">&lt;&lt;</span> _animal<span style="color:#f92672">-&gt;</span>name() <span style="color:#f92672">&lt;&lt;</span> endl; }
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><ul>
<li>Then the client said that if the <code>Animal</code> was a <code>Horse</code>, they wanted to try to ride it.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> Person<span style="color:#f92672">::</span>ReactTo(Animal <span style="color:#f92672">*</span>_animal) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">dynamic_cast</span><span style="color:#f92672">&lt;</span>Dog <span style="color:#f92672">*&gt;</span>(_animal))
</span></span><span style="display:flex;"><span>        RunAwayFrom(_animal);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> <span style="color:#a6e22e">if</span> (<span style="color:#66d9ef">dynamic_cast</span><span style="color:#f92672">&lt;</span>Cat <span style="color:#f92672">*&gt;</span>(_animal))
</span></span><span style="display:flex;"><span>        TryToPet(_animal);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> <span style="color:#a6e22e">if</span> (<span style="color:#66d9ef">dynamic_cast</span><span style="color:#f92672">&lt;</span>Horse <span style="color:#f92672">*&gt;</span>(_animal))
</span></span><span style="display:flex;"><span>        TryToRide(_animal);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>You see this is going crazy. At some point in future, you might not like working with your own code. We&rsquo;ve all been there. Nonetheless, the trend continued for some time until you may found yourself with a mess like this:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> Person<span style="color:#f92672">::</span>ReactTo(Animal <span style="color:#f92672">*</span>_animal) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">dynamic_cast</span><span style="color:#f92672">&lt;</span>Dog <span style="color:#f92672">*&gt;</span>(_animal) <span style="color:#f92672">||</span> <span style="color:#66d9ef">dynamic_cast</span><span style="color:#f92672">&lt;</span>Gerbil <span style="color:#f92672">*&gt;</span>(_animal)) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">dynamic_cast</span><span style="color:#f92672">&lt;</span>Dog <span style="color:#f92672">*&gt;</span>(_animal) <span style="color:#f92672">&amp;&amp;</span> <span style="color:#66d9ef">dynamic_cast</span><span style="color:#f92672">&lt;</span>Dog<span style="color:#f92672">&gt;</span>()<span style="color:#f92672">-&gt;</span>GetBreed() <span style="color:#f92672">==</span> DogBreed.Daschund) <span style="color:#75715e">// Daschund&#39;s are the exception
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            TryToPet(_animal);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">RunAwayFrom</span>(_animal);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> <span style="color:#a6e22e">if</span> (<span style="color:#66d9ef">dynamic_cast</span><span style="color:#f92672">&lt;</span>Cat <span style="color:#f92672">*&gt;</span>(_animal) <span style="color:#f92672">||</span> <span style="color:#66d9ef">dynamic_cast</span><span style="color:#f92672">&lt;</span>Pig <span style="color:#f92672">*&gt;</span>(_animal))
</span></span><span style="display:flex;"><span>        TryToPet(_animal);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> <span style="color:#a6e22e">if</span> (<span style="color:#66d9ef">dynamic_cast</span><span style="color:#f92672">&lt;</span>Horse <span style="color:#f92672">*&gt;</span>(_animal))
</span></span><span style="display:flex;"><span>        TryToRide(_animal);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> <span style="color:#a6e22e">if</span> (<span style="color:#66d9ef">dynamic_cast</span><span style="color:#f92672">&lt;</span>Lizard <span style="color:#f92672">*&gt;</span>(_animal))
</span></span><span style="display:flex;"><span>        TryToFeed(_animal);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">dynamic_cast</span><span style="color:#f92672">&lt;</span>Mole <span style="color:#f92672">*&gt;</span>(_animal))
</span></span><span style="display:flex;"><span>        Attack(_animal)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// etc.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><ul>
<li>This list is getting pretty long, you thought to yourself one day. All these <a href="/posts/cpp-type-casting-with-example-for-c-developers/" >dynamic_cast&lt;&gt;()</a> seem wrong, and they&rsquo;re kind of slow as well. So on a side note of refactorization, you come up with a solution which identifies <code>typeid()</code>, this is a bit faster than <a href="/posts/cpp-type-casting-with-example-for-c-developers/" ><code>dynamic_cast&lt;&gt;()</code></a> but still, it&rsquo;s not optimum performance.</li>
</ul>
<h2 id="exploiting-polymorphism">
  Exploiting Polymorphism
  <a class="heading-link" href="#exploiting-polymorphism">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<ul>
<li>As someone from your senior/mentor suggests you to use an enum with polymorphic methods to identify type &amp; you wrote following code:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">enum</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AnimalType</span> { Dog, Cat };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Animal</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">virtual</span> <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">name</span>() <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">virtual</span> AnimalType <span style="color:#a6e22e">type</span>() <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Cat</span> <span style="color:#f92672">:</span> Animal {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">name</span>() { <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;Cat&#34;</span>; }
</span></span><span style="display:flex;"><span>    AnimalType <span style="color:#a6e22e">type</span>() { <span style="color:#66d9ef">return</span> AnimalType<span style="color:#f92672">::</span>Cat; }
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Dog</span> <span style="color:#f92672">:</span> Animal {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">name</span>() { <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;Dog&#34;</span>; }
</span></span><span style="display:flex;"><span>    AnimalType <span style="color:#a6e22e">type</span>() { <span style="color:#66d9ef">return</span> AnimalType<span style="color:#f92672">::</span>Dog; }
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Person</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">ReactTo</span>(Animal <span style="color:#f92672">*</span>_animal) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (_animal<span style="color:#f92672">-&gt;</span>type() <span style="color:#f92672">==</span> AnimalType<span style="color:#f92672">::</span>Cat)
</span></span><span style="display:flex;"><span>            TryToPet(_animal);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (_animal<span style="color:#f92672">-&gt;</span>type() <span style="color:#f92672">==</span> AnimalType<span style="color:#f92672">::</span>Dog)
</span></span><span style="display:flex;"><span>            RunAwayFrom(_animal);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">RunAwayFrom</span>(Animal <span style="color:#f92672">*</span>_animal) { cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;Run Away From &#34;</span> <span style="color:#f92672">&lt;&lt;</span> _animal<span style="color:#f92672">-&gt;</span>name() <span style="color:#f92672">&lt;&lt;</span> endl; }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">TryToPet</span>(Animal <span style="color:#f92672">*</span>_animal) { cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;Try To Pet &#34;</span> <span style="color:#f92672">&lt;&lt;</span> _animal<span style="color:#f92672">-&gt;</span>name() <span style="color:#f92672">&lt;&lt;</span> endl; }
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    Person p;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Animal <span style="color:#f92672">*</span>animal_0 <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Dog;
</span></span><span style="display:flex;"><span>    p.ReactTo(animal_0);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Animal <span style="color:#f92672">*</span>animal_1 <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Cat;
</span></span><span style="display:flex;"><span>    p.ReactTo(animal_1);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>You may get the performance improvement, but still, you will be left with a long list of <code>if/else-if</code>.</li>
</ul>
<h2 id="more-functional--modular-approach">
  More Functional &amp; Modular Approach
  <a class="heading-link" href="#more-functional--modular-approach">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">using</span> PersonMethodPtr <span style="color:#f92672">=</span> <span style="color:#66d9ef">void</span> (Person<span style="color:#f92672">::*</span>)(Animal <span style="color:#f92672">*</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> ReactionHash <span style="color:#f92672">=</span> unordered_map<span style="color:#f92672">&lt;</span>AnimalType, PersonMethodPtr<span style="color:#f92672">&gt;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> Person<span style="color:#f92672">::</span>ReactTo(Animal <span style="color:#f92672">*</span>_animal)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">const</span> ReactionHash reactionFunctions{
</span></span><span style="display:flex;"><span>        {AnimalType<span style="color:#f92672">::</span>Cat, <span style="color:#f92672">&amp;</span>TryToPet},
</span></span><span style="display:flex;"><span>        {AnimalType<span style="color:#f92672">::</span>Dog, <span style="color:#f92672">&amp;</span>RunAwayFrom},
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// etc.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    reactionFunctions[_animal<span style="color:#f92672">-&gt;</span>type()](_animal);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>But here you are indirectly writing your own <a href="/posts/part-1-all-about-virtual-keyword-in-cpp-how-virtual-function-works-internally/" >virtual table</a>(a very bad virtual table) which may not provide any performance gain at all, thanks to the overhead of hashing &amp; lookup. Moreover, you are paying a little extra in memory to store your lookup table.</li>
</ul>
<h2 id="single-dispatch">
  Single-Dispatch
  <a class="heading-link" href="#single-dispatch">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<ul>
<li>So rather than keeping any identifier for each type or RTTI, we can use a middle man to route function call to appropriate behaviour.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Animal</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">virtual</span> string <span style="color:#a6e22e">name</span>() <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">virtual</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">Visit</span>(<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ReactVisitor</span> <span style="color:#f92672">*</span>visitor) <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">ReactVisitor</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Person</span> <span style="color:#f92672">*</span>person <span style="color:#f92672">=</span> <span style="color:#66d9ef">nullptr</span>;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Person</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">ReactTo</span>(Animal <span style="color:#f92672">*</span>_animal) {
</span></span><span style="display:flex;"><span>        ReactVisitor visitor{<span style="color:#66d9ef">this</span>};
</span></span><span style="display:flex;"><span>        _animal<span style="color:#f92672">-&gt;</span>Visit(<span style="color:#f92672">&amp;</span>visitor);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">RunAwayFrom</span>(Animal <span style="color:#f92672">*</span>_animal) { cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;Run Away From &#34;</span> <span style="color:#f92672">&lt;&lt;</span> _animal<span style="color:#f92672">-&gt;</span>name() <span style="color:#f92672">&lt;&lt;</span> endl; }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">TryToPet</span>(Animal <span style="color:#f92672">*</span>_animal) { cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;Try To Pet &#34;</span> <span style="color:#f92672">&lt;&lt;</span> _animal<span style="color:#f92672">-&gt;</span>name() <span style="color:#f92672">&lt;&lt;</span> endl; }
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Cat</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">public</span> Animal {
</span></span><span style="display:flex;"><span>    string <span style="color:#a6e22e">name</span>() { <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;Cat&#34;</span>; }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">Visit</span>(ReactVisitor <span style="color:#f92672">*</span>visitor) { visitor<span style="color:#f92672">-&gt;</span>person<span style="color:#f92672">-&gt;</span>TryToPet(<span style="color:#66d9ef">this</span>); }
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Dog</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">public</span> Animal {
</span></span><span style="display:flex;"><span>    string <span style="color:#a6e22e">name</span>() { <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;Dog&#34;</span>; }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">Visit</span>(ReactVisitor <span style="color:#f92672">*</span>visitor) { visitor<span style="color:#f92672">-&gt;</span>person<span style="color:#f92672">-&gt;</span>RunAwayFrom(<span style="color:#66d9ef">this</span>); }
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    Person p;
</span></span><span style="display:flex;"><span>    vector<span style="color:#f92672">&lt;</span>Animal<span style="color:#f92672">*&gt;</span> animals <span style="color:#f92672">=</span> {<span style="color:#66d9ef">new</span> Dog, <span style="color:#66d9ef">new</span> Cat};
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">auto</span><span style="color:#f92672">&amp;&amp;</span> animal : animals)
</span></span><span style="display:flex;"><span>        p.ReactTo(animal);    
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>To keep the middle man to a route function call, we have to add <code>visit(ReactVisitor *)</code> method which accepts middle man i.e. <code>ReactVisitor</code> as a parameter. Then we add appropriate behaviour to each type of <code>Animal</code> i.e. <code>Dog</code> &amp; <code>Cat</code>.</li>
</ul>
<h3 id="problems-with-the-single-dispatch-approach">
  Problems With the Single Dispatch Approach
  <a class="heading-link" href="#problems-with-the-single-dispatch-approach">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<ol>
<li>Why should the <code>Dog</code> class dictate how a <code>Person</code> reacts to it? We have leaked implementation details of the <code>Person</code> class and therefore have violated encapsulation.</li>
<li>What if the <code>Person</code> class has other behaviours they want to implement? Are we really going to add a new <a href="/posts/part-1-all-about-virtual-keyword-in-cpp-how-virtual-function-works-internally/" >virtual method</a> on the base class for each of them?</li>
</ol>
<p>The solution to the above problem will lead us to use Double-Dispatch Mechanism.</p>
<h2 id="double-dispatch-in-c">
  Double Dispatch in C++
  <a class="heading-link" href="#double-dispatch-in-c">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<ul>
<li>We can overcome the shortcoming of Single-Dispatch by adding one more layer of indirection(i.e. <code>AnimalVisitor</code>).</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">/* -------------------------------- Added Visitor Classes ------------------------------- */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">AnimalVisitor</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">virtual</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">Visit</span>(<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Cat</span> <span style="color:#f92672">*</span>) <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">virtual</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">Visit</span>(<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Dog</span> <span style="color:#f92672">*</span>) <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">ReactVisitor</span> <span style="color:#f92672">:</span> AnimalVisitor {
</span></span><span style="display:flex;"><span>    ReactVisitor(<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Person</span> <span style="color:#f92672">*</span>p) <span style="color:#f92672">:</span> person{p} {}
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">Visit</span>(<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Cat</span> <span style="color:#f92672">*</span>c);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">Visit</span>(<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Dog</span> <span style="color:#f92672">*</span>d);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Person</span> <span style="color:#f92672">*</span>person <span style="color:#f92672">=</span> <span style="color:#66d9ef">nullptr</span>;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* --------------------------------------------------------------------------------------- */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Animal</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">virtual</span> string <span style="color:#a6e22e">name</span>() <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">virtual</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">Visit</span>(<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">AnimalVisitor</span> <span style="color:#f92672">*</span>visitor) <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;      
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Cat</span> <span style="color:#f92672">:</span> Animal {
</span></span><span style="display:flex;"><span>    string <span style="color:#a6e22e">name</span>() { <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;Cat&#34;</span>; }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">Visit</span>(AnimalVisitor <span style="color:#f92672">*</span>visitor) { visitor<span style="color:#f92672">-&gt;</span>Visit(<span style="color:#66d9ef">this</span>); } <span style="color:#75715e">// 2nd dispatch &lt;&lt;---------
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>};
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Dog</span> <span style="color:#f92672">:</span> Animal {
</span></span><span style="display:flex;"><span>    string <span style="color:#a6e22e">name</span>() { <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;Dog&#34;</span>; }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">Visit</span>(AnimalVisitor <span style="color:#f92672">*</span>visitor) { visitor<span style="color:#f92672">-&gt;</span>Visit(<span style="color:#66d9ef">this</span>); } <span style="color:#75715e">// 2nd dispatch &lt;&lt;---------
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Person</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">ReactTo</span>(Animal <span style="color:#f92672">*</span>_animal) {
</span></span><span style="display:flex;"><span>        ReactVisitor visitor{<span style="color:#66d9ef">this</span>};
</span></span><span style="display:flex;"><span>        _animal<span style="color:#f92672">-&gt;</span>Visit(<span style="color:#f92672">&amp;</span>visitor);   <span style="color:#75715e">// 1st dispatch &lt;&lt;---------
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">RunAwayFrom</span>(Animal <span style="color:#f92672">*</span>_animal) { cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;Run Away From &#34;</span> <span style="color:#f92672">&lt;&lt;</span> _animal<span style="color:#f92672">-&gt;</span>name() <span style="color:#f92672">&lt;&lt;</span> endl; }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">TryToPet</span>(Animal <span style="color:#f92672">*</span>_animal) { cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;Try To Pet &#34;</span> <span style="color:#f92672">&lt;&lt;</span> _animal<span style="color:#f92672">-&gt;</span>name() <span style="color:#f92672">&lt;&lt;</span> endl; }
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* -------------------------------- Added Visitor Methods ------------------------------- */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> ReactVisitor<span style="color:#f92672">::</span>Visit(Cat <span style="color:#f92672">*</span>c) { <span style="color:#75715e">// Finally comes here &lt;&lt;-------------
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    person<span style="color:#f92672">-&gt;</span>TryToPet(c);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> ReactVisitor<span style="color:#f92672">::</span>Visit(Dog <span style="color:#f92672">*</span>d) { <span style="color:#75715e">// Finally comes here &lt;&lt;-------------
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    person<span style="color:#f92672">-&gt;</span>RunAwayFrom(d);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* --------------------------------------------------------------------------------------- */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    Person p;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">auto</span><span style="color:#f92672">&amp;&amp;</span> animal : vector<span style="color:#f92672">&lt;</span>Animal<span style="color:#f92672">*&gt;</span>{<span style="color:#66d9ef">new</span> Dog, <span style="color:#66d9ef">new</span> Cat})
</span></span><span style="display:flex;"><span>        p.ReactTo(animal);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>As you can see above, rather depending directly on <code>ReactVisitor</code>, we have taken <code>AnimalVisitor</code> as one more layer of indirection. And <code>visit(AnimalVisitor *)</code> method in <code>Cat</code> &amp; <code>Dog</code> class accept <code>AnimalVisitor</code> as a parameter.</li>
<li>This gives us two benefits, i). we do not have to write person&rsquo;s behaviour in <code>Cat</code> &amp; <code>Dog</code> class, so we are not breaking the rule of encapsulation, and ii). we are clubbing the reaction of Person in a separate class(i.e. <code>ReactVisitor</code>), so we are encouraging the <a href="/posts/single-responsibility-principle-in-cpp-solid-as-a-rock/" >Single Responsibility Principle</a>.</li>
</ul>
<h2 id="how-does-double-dispatch-mechanism-work">
  How does Double Dispatch Mechanism work?
  <a class="heading-link" href="#how-does-double-dispatch-mechanism-work">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>I know so things are getting complex, but it is reasonably complex I would say. Function stack frame &amp; single image of function calling chain with code snippet will simplify it a lot.</p>
<p><img src="/images/double-dispatch-cpp-stack-frame-vishal-chovatiya.gif"></p>
<ul>
<li>From <code>Person::ReactTo</code>, we call <code>Animal::visit</code>, which will dispatch to the appropriate overridden visit i.e. either <code>Cat::visit</code> or <code>Dog::visit</code>.</li>
<li>From the overridden <code>Cat::visit(AnimalVisitor*)</code>, we call <code>AnimalVisitor::visit</code>, which will again dispatch to the appropriate overridden i.e. either <code>ReactionVisitor::visit(Cat*) or </code>ReactionVisitor::visit(Dog*)`.</li>
</ul>
<h2 id="alternate-approach-to-double-dispatch-in-modern-c-using-stdvariant--stdvisit">
  Alternate Approach to Double Dispatch in Modern C++ using std::variant &amp; std::visit
  <a class="heading-link" href="#alternate-approach-to-double-dispatch-in-modern-c-using-stdvariant--stdvisit">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Animal</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">virtual</span> string <span style="color:#a6e22e">name</span>() <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Cat</span> <span style="color:#f92672">:</span> Animal {
</span></span><span style="display:flex;"><span>    string <span style="color:#a6e22e">name</span>() { <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;Cat&#34;</span>; }
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Dog</span> <span style="color:#f92672">:</span> Animal {
</span></span><span style="display:flex;"><span>    string <span style="color:#a6e22e">name</span>() { <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;Dog&#34;</span>; }
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Person</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">RunAwayFrom</span>(Animal <span style="color:#f92672">*</span>animal) { cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;Run Away From &#34;</span> <span style="color:#f92672">&lt;&lt;</span> animal<span style="color:#f92672">-&gt;</span>name() <span style="color:#f92672">&lt;&lt;</span> endl; }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">TryToPet</span>(Animal <span style="color:#f92672">*</span>animal) { cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;Try To Pet &#34;</span> <span style="color:#f92672">&lt;&lt;</span> animal<span style="color:#f92672">-&gt;</span>name() <span style="color:#f92672">&lt;&lt;</span> endl; }
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">ReactVisitor</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">operator</span>()(Cat <span style="color:#f92672">*</span>c) { person<span style="color:#f92672">-&gt;</span>TryToPet(c); }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">operator</span>()(Dog <span style="color:#f92672">*</span>d){ person<span style="color:#f92672">-&gt;</span>RunAwayFrom(d); }
</span></span><span style="display:flex;"><span>    Person <span style="color:#f92672">*</span>person <span style="color:#f92672">=</span> <span style="color:#66d9ef">nullptr</span>;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> animal_ptr <span style="color:#f92672">=</span> std<span style="color:#f92672">::</span>variant<span style="color:#f92672">&lt;</span>Cat<span style="color:#f92672">*</span>, Dog<span style="color:#f92672">*&gt;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    Person p;
</span></span><span style="display:flex;"><span>    ReactVisitor rv{<span style="color:#f92672">&amp;</span>p};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">auto</span><span style="color:#f92672">&amp;&amp;</span> animal : vector<span style="color:#f92672">&lt;</span>animal_ptr<span style="color:#f92672">&gt;</span>({<span style="color:#66d9ef">new</span> Dog, <span style="color:#66d9ef">new</span> Cat}))
</span></span><span style="display:flex;"><span>        std<span style="color:#f92672">::</span>visit(rv, animal);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>So for those of you who are not familiar with the <code>std::variant</code>, you can consider it as a union. And line <code>std::variant&lt;Cat*, Dog*&gt;</code>, suggest that you can use/assign/access either <code>Cat*</code> or <code>Dog*</code> at a time.</li>
<li>And <a href="/posts/21-new-features-of-modern-cpp-to-use-in-your-project/" >Modern C++</a> provide us <code>std::visit</code> which accept callable i.e. <code>ReactVisitor</code> in our case having overloaded function operator for each type and <code>std::variant</code>. You also make use of <a href="/posts/learn-lambda-function-in-cpp-with-example/" >lambda functions</a> rather using functor i.e. <code>ReactVisitor</code>.</li>
</ul>
<h2 id="benefits-of-double-dispatch-mechanism">
  Benefits of Double Dispatch Mechanism
  <a class="heading-link" href="#benefits-of-double-dispatch-mechanism">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<ol>
<li>Adhering <a href="/posts/single-responsibility-principle-in-cpp-solid-as-a-rock/" >Single Responsibility Principle</a> meaning separating type-specific logic in the separate entity/class. In our case, <code>ReactVisitor</code> only handles the reaction for different Animal types.</li>
<li>Adhering <a href="/posts/open-closed-principle-in-cpp-solid-as-a-rock/" >Open-Closed Principle</a> meaning new functionality can be added without touching any class headers once we inserted <code>visit()</code> method for hierarchy, For example, if you want to add <code>sound()</code>method for each different Animal, you can create <code>SoundVisitor</code> &amp; rest of the edit goes as same <code>ReactVisitor</code>.</li>
<li>This will be much useful when you already have done the unit-testing for your entire hierarchy, and now you do not want to touch that &amp; wants to add new functionality.</li>
<li>Performance over <code>dynamic_cast</code>, <code>typeid()</code>and check for <code>enum</code>/<code>string</code> comparison.</li>
</ol>
<h2 id="usecase-of-double-dispatch-mechanism">
  Usecase of Double Dispatch Mechanism
  <a class="heading-link" href="#usecase-of-double-dispatch-mechanism">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<ol>
<li>Sorting a mixed set of objects: You can implement filtering with double-dispatch. E.g., &ldquo;Give me all the<code>Cats</code> from a <code>vector&lt;Animal*&gt;</code>&rdquo;.</li>
<li>You can add additional functionality to the whole inheritance hierarchy without modifying it over &amp; over E.g. if you want to add <code>sound()</code>method for each different Animal, you can create <code>SoundVisitor</code> &amp; rest of the edit goes as same <code>ReactVisitor</code>.</li>
<li>Event handling systems that use both the event type and the type of the receptor object in order to call the correct event handling routine.</li>
<li><a href="https://en.wikipedia.org/wiki/Double_dispatch#Double_dispatch_in_C&#43;&#43;"  class="external-link" target="_blank" rel="noopener">Adaptive collision algorithms</a> usually require that collisions between different objects be handled in different ways. A typical example is in a game environment where the collision between a spaceship and an asteroid is computed differently from the collision between a spaceship and a space station.</li>
</ol>
<h2 id="conclusion">
  Conclusion
  <a class="heading-link" href="#conclusion">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>Each solution has its advantages and issues, and choosing one depends on the exact needs of your project. C++ presents unique challenges in designing such high-level abstractions because it&rsquo;s comparatively rigid and statically typed. Abstractions in C++ also tend to strive to be as cheap as possible in terms of runtime performance and memory consumption, which adds another dimension of complexity to the problem.</p>
<h2 id="reference">
  Reference
  <a class="heading-link" href="#reference">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>This article becomes by-product while I was writing about classic <a href="/posts/double-dispatch-visitor-design-pattern-in-modern-cpp/" >Visitor Design Pattern</a> because without double dispatch mechanism in C++ classic visitor doesn&rsquo;t exist. Most of the credit for this article &amp; images goes to <a href="https://gieseanw.wordpress.com/2018/12/29/reuse-double-dispatch/"  class="external-link" target="_blank" rel="noopener">Andy G</a>. The code snippets you see in this article is simplified not sophisticated.</p>

      </div>


      <footer>
        


        
        
        
        
        

        
        
      </footer>
    </article>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css"
    integrity="sha384-vKruj+a13U8yHIkAyGgK1J3ArTLzrFGBbBc0tDp4ad/EyewESeXE/Iv67Aj8gKZ0" crossorigin="anonymous">
  
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js"
    integrity="sha384-PwRUT/YqbnEjkZO0zZxNqcxACrXe+j766U2amXcgMg5457rve2Y7I6ZJSm2A0mS4" crossorigin="anonymous"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js"
    integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"
    onload="renderMathInElement(document.body,
      {
        delimiters: [
          {left: '$$', right: '$$', display:true},
          {left: '$', right: '$', display:false},
          {left: '\\(', right: '\\)', display: false},
          {left: '\\[', right: '\\]', display: true}
        ]
      }
    );"></script>
  </section>

    </div>

    <footer class="footer">
  <section class="container">
    ©
    
    2024
     Vishal Chovatiya 
    ·
    
    Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/" target="_blank" rel="noopener">Coder</a>.
    
  </section>
</footer>

  </main>

  

  
  
  <script src="/js/coder.js"></script>
  

  

  


  
  



  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
</body>

</html>
